---
phase: 04-inbound-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-api-client.php
  - includes/class-sync-poller.php
autonomous: false

must_haves:
  truths:
    - "Donation totals are fetched from Classy every 15 minutes"
    - "Campaign status (active/unpublished/deactivated) is stored in post meta"
    - "Goal progress percentage is calculated and stored"
    - "Inbound sync does not trigger outbound sync"
  artifacts:
    - path: "includes/class-api-client.php"
      provides: "get_campaign_overview() method"
      contains: "function get_campaign_overview"
    - path: "includes/class-sync-poller.php"
      provides: "poll_campaigns() method"
      contains: "function poll_campaigns"
  key_links:
    - from: "includes/class-sync-poller.php"
      to: "includes/class-api-client.php"
      via: "get_campaign_overview() call"
      pattern: "\\$this->api->get_campaign_overview"
    - from: "includes/class-sync-poller.php"
      to: "WordPress post meta"
      via: "update_post_meta() calls"
      pattern: "update_post_meta.*_gofundme_donation_total"
---

<objective>
Implement inbound synchronization from Classy to WordPress, polling campaign donation totals and status every 15 minutes.

Purpose: Enable WordPress to display real-time fundraising progress by pulling donation data from Classy without manual intervention.

Output: Extended sync poller that fetches campaign overview data and stores donation totals, donor counts, goal progress, and campaign status in post meta.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-inbound-sync/04-RESEARCH.md

# Key source files
@includes/class-api-client.php
@includes/class-sync-poller.php
@includes/class-sync-handler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add campaign overview API method</name>
  <files>includes/class-api-client.php</files>
  <action>
Add `get_campaign_overview()` method to FCG_GFM_API_Client class.

Location: Add after the existing `get_campaign()` method (around line 321).

Method signature and implementation:
```php
/**
 * Get campaign overview with donation totals
 *
 * Returns aggregated donation data including total raised, donor count, etc.
 * Note: Amounts are returned as strings (e.g., "8850.00") - cast to float as needed.
 *
 * @param int|string $campaign_id Campaign ID
 * @return array Response with overview data
 */
public function get_campaign_overview($campaign_id): array {
    return $this->request('GET', "/campaigns/{$campaign_id}/overview");
}
```

The overview endpoint returns:
- `total_gross_amount` (string): Total gross donations (USE THIS for donation_total)
- `donors_count` (int): Number of unique donors
- `gross_amount`, `net_amount`, `fees_amount` (strings): Detailed breakdown
- `transactions_count` (int): Total transactions

Why this design:
- Follows existing pattern from `get_campaign()` method
- Single responsibility - just fetches data, caller handles type conversion
- Docblock warns about string amounts needing cast to float
  </action>
  <verify>
Grep for method definition:
```bash
grep -n "function get_campaign_overview" includes/class-api-client.php
```
Should return line number with method definition.
  </verify>
  <done>
`get_campaign_overview()` method exists in API client with correct endpoint `/campaigns/{id}/overview`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend sync poller with campaign polling</name>
  <files>includes/class-sync-poller.php</files>
  <action>
Extend FCG_GFM_Sync_Poller to poll campaigns alongside designations.

**1. Add new constants at top of class (after existing constants around line 35):**
```php
/**
 * Meta key for donation total
 */
private const META_DONATION_TOTAL = '_gofundme_donation_total';

/**
 * Meta key for donor count
 */
private const META_DONOR_COUNT = '_gofundme_donor_count';

/**
 * Meta key for goal progress percentage
 */
private const META_GOAL_PROGRESS = '_gofundme_goal_progress';

/**
 * Meta key for campaign status
 */
private const META_CAMPAIGN_STATUS = '_gofundme_campaign_status';

/**
 * Meta key for last inbound sync timestamp
 */
private const META_LAST_INBOUND_SYNC = '_gofundme_last_inbound_sync';
```

**2. Modify poll() method to also poll campaigns (around line 100):**
At the END of the existing poll() method, BEFORE `$this->set_last_poll_time();`, add:
```php
// Poll campaigns for donation data (Phase 4)
$this->poll_campaigns();
```

**3. Add new poll_campaigns() private method (after poll() method):**
```php
/**
 * Poll campaigns for donation data
 *
 * Fetches donation totals, donor counts, and status from Classy
 * and stores in WordPress post meta.
 */
private function poll_campaigns(): void {
    // Find all funds with campaign IDs
    $funds_with_campaigns = get_posts([
        'post_type' => 'funds',
        'posts_per_page' => -1,
        'post_status' => ['publish', 'draft', 'pending'],
        'meta_query' => [
            [
                'key' => '_gofundme_campaign_id',
                'compare' => 'EXISTS',
            ],
        ],
    ]);

    if (empty($funds_with_campaigns)) {
        $this->log("Campaign poll: No funds with campaigns found");
        return;
    }

    $stats = [
        'processed' => 0,
        'updated' => 0,
        'errors' => 0,
    ];

    foreach ($funds_with_campaigns as $post) {
        $campaign_id = get_post_meta($post->ID, '_gofundme_campaign_id', true);
        if (empty($campaign_id)) {
            continue;
        }

        $stats['processed']++;

        if ($this->sync_campaign_inbound($post->ID, $campaign_id)) {
            $stats['updated']++;
        } else {
            $stats['errors']++;
        }

        // Small delay between API calls to avoid rate limiting
        usleep(50000); // 50ms
    }

    $this->log(sprintf(
        "Campaign poll complete: %d processed, %d updated, %d errors",
        $stats['processed'],
        $stats['updated'],
        $stats['errors']
    ));
}

/**
 * Sync inbound campaign data for a single fund
 *
 * @param int $post_id WordPress post ID
 * @param string $campaign_id Classy campaign ID
 * @return bool True if sync successful
 */
private function sync_campaign_inbound(int $post_id, string $campaign_id): bool {
    $this->set_syncing_flag();

    try {
        // Fetch campaign data (for status and goal)
        $campaign = $this->api->get_campaign($campaign_id);
        if (!$campaign['success']) {
            $this->log("Failed to fetch campaign {$campaign_id} for post {$post_id}: " . ($campaign['error'] ?? 'Unknown'));
            return false;
        }

        // Fetch campaign overview (for donation totals)
        $overview = $this->api->get_campaign_overview($campaign_id);
        if (!$overview['success']) {
            $this->log("Failed to fetch campaign overview {$campaign_id} for post {$post_id}: " . ($overview['error'] ?? 'Unknown'));
            return false;
        }

        // Store campaign status
        $status = $campaign['data']['status'] ?? '';
        update_post_meta($post_id, self::META_CAMPAIGN_STATUS, $status);

        // Store donation total (API returns string, cast to float)
        $total = floatval($overview['data']['total_gross_amount'] ?? 0);
        update_post_meta($post_id, self::META_DONATION_TOTAL, $total);

        // Store donor count
        $donor_count = intval($overview['data']['donors_count'] ?? 0);
        update_post_meta($post_id, self::META_DONOR_COUNT, $donor_count);

        // Calculate and store goal progress percentage
        $goal = floatval($campaign['data']['goal'] ?? 0);
        $progress = ($goal > 0) ? round(($total / $goal) * 100, 1) : 0.0;
        update_post_meta($post_id, self::META_GOAL_PROGRESS, $progress);

        // Update inbound sync timestamp
        update_post_meta($post_id, self::META_LAST_INBOUND_SYNC, current_time('mysql'));

        return true;

    } finally {
        $this->clear_syncing_flag();
    }
}
```

**Key design decisions:**
- Uses existing `set_syncing_flag()` / `clear_syncing_flag()` pattern to prevent outbound sync loop
- 50ms delay between API calls to avoid potential rate limiting
- Handles both campaign endpoint (status, goal) and overview endpoint (totals)
- Progress can exceed 100% if goal is surpassed (no cap)
- Updates `_gofundme_last_inbound_sync` separately from existing `_gofundme_last_sync` (outbound)
- Does NOT modify WordPress post_status based on campaign status (WordPress is source of truth)

**Anti-patterns avoided:**
- NOT using wp_update_post() - only update_post_meta() which does not trigger save_post hooks
- NOT capping progress at 100% - allows showing exceeded goals
- NOT changing post_status - campaign status is informational only
  </action>
  <verify>
1. Check constants added:
```bash
grep -n "META_DONATION_TOTAL\|META_CAMPAIGN_STATUS" includes/class-sync-poller.php
```

2. Check poll_campaigns method exists:
```bash
grep -n "function poll_campaigns\|function sync_campaign_inbound" includes/class-sync-poller.php
```

3. Check poll() calls poll_campaigns():
```bash
grep -n "poll_campaigns" includes/class-sync-poller.php
```

All should return matching line numbers.
  </verify>
  <done>
Sync poller extended with:
- New meta key constants defined
- `poll()` method calls `poll_campaigns()`
- `poll_campaigns()` queries funds with campaign IDs
- `sync_campaign_inbound()` fetches and stores donation data
- Syncing flag prevents outbound sync loop
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Inbound campaign sync implementation:
- API client method for campaign overview endpoint
- Campaign polling integrated into 15-minute cron job
- Donation totals, donor counts, progress, and status stored in post meta
  </what-built>
  <how-to-verify>
**1. Bump plugin version:**
Update version in `fcg-gofundme-sync.php` header from 2.1.6 to 2.2.0 (new feature release).

**2. Deploy to staging:**
```bash
rsync -avz --exclude='.git' --exclude='.planning' --exclude='*.zip' \
  /Users/chadmacbook/projects/fcg/ \
  frederickc2stg@frederickc2stg.ssh.wpengine.net:~/sites/frederickc2stg/wp-content/plugins/fcg-gofundme-sync/
```

**3. SSH to staging and manually trigger cron:**
```bash
ssh frederickc2stg@frederickc2stg.ssh.wpengine.net
cd ~/sites/frederickc2stg
wp cron event run fcg_gofundme_sync_poll
```

**4. Check that donation data was synced (pick a fund with a campaign):**
```bash
# Get a post ID that has a campaign
wp post list --post_type=funds --meta_key=_gofundme_campaign_id --fields=ID,post_title --format=table | head -5

# Check inbound sync meta for that post (replace POSTID)
wp post meta get POSTID _gofundme_donation_total
wp post meta get POSTID _gofundme_donor_count
wp post meta get POSTID _gofundme_goal_progress
wp post meta get POSTID _gofundme_campaign_status
wp post meta get POSTID _gofundme_last_inbound_sync
```

**5. Verify no outbound sync triggered:**
Edit a fund in WordPress admin, change title slightly, save.
Check that `_gofundme_last_sync` (outbound) updates but donation meta stays the same.

**Expected results:**
- `_gofundme_donation_total`: Float value (e.g., 8850.00)
- `_gofundme_donor_count`: Integer (e.g., 39)
- `_gofundme_goal_progress`: Float percentage (e.g., 88.5)
- `_gofundme_campaign_status`: "active", "unpublished", or "deactivated"
- `_gofundme_last_inbound_sync`: Recent timestamp
  </how-to-verify>
  <resume-signal>Type "verified" if donation data synced correctly and outbound sync still works, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
Phase 4 requirements verification:

| Requirement | How to Verify |
|-------------|--------------|
| SYNC-01: Donation totals polled every 15 min | `wp cron event list` shows `fcg_gofundme_sync_poll` scheduled; `_gofundme_donation_total` populated |
| SYNC-02: Campaign status reflected in WP | `_gofundme_campaign_status` meta contains active/unpublished/deactivated |
| SYNC-03: Goal progress calculated | `_gofundme_goal_progress` meta contains percentage |
| SYNC-04: No outbound sync triggered | Edit fund, save; `_gofundme_last_sync` updates but donation meta unchanged |
</verification>

<success_criteria>
- [ ] `get_campaign_overview()` method exists in API client
- [ ] `poll_campaigns()` method exists in sync poller
- [ ] Campaign polling integrated into existing 15-min cron
- [ ] Plugin version bumped to 2.2.0
- [ ] Donation meta keys populated after cron runs
- [ ] Outbound sync still works (edit fund triggers update to Classy)
- [ ] Inbound sync does NOT trigger outbound sync (no loop)
</success_criteria>

<output>
After completion, create `.planning/phases/04-inbound-sync/04-01-SUMMARY.md`
</output>
