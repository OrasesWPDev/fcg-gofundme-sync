---
phase: 05-code-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-sync-poller.php
  - includes/class-admin-ui.php
autonomous: true

must_haves:
  truths:
    - "Inbound sync polling still runs without errors"
    - "Admin UI displays designation info correctly"
    - "Campaign poll gracefully handles empty campaign meta"
  artifacts:
    - path: "includes/class-sync-poller.php"
      provides: "Sync poller with graceful campaign poll degradation"
      min_lines: 900
    - path: "includes/class-admin-ui.php"
      provides: "Admin UI without campaign ID display"
      min_lines: 600
  key_links:
    - from: "includes/class-sync-poller.php"
      to: "includes/class-api-client.php"
      via: "get_campaign_overview for donation totals"
      pattern: "get_campaign_overview"
---

<objective>
Update sync poller and admin UI for post-pivot architecture

Purpose: Sync poller needs graceful degradation for orphaned campaign meta; admin UI should not display stale campaign data
Output: Updated poller and admin UI compatible with single master campaign architecture
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-code-cleanup/05-CONTEXT.md
@.planning/phases/05-code-cleanup/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update sync-poller.php for graceful campaign poll degradation</name>
  <files>includes/class-sync-poller.php</files>
  <action>
Update poll_campaigns() method (lines 202-251) to handle the transition period gracefully:

1. The method currently polls funds with `_gofundme_campaign_id` meta for donation data
2. After architecture pivot, no new funds will have campaign IDs
3. Existing funds may still have orphaned campaign IDs

**Changes to make:**

In poll_campaigns() method, add an early return with informative log message if no funds have campaigns:

```php
private function poll_campaigns(): void {
    // Find all funds with campaign IDs (legacy from per-fund campaign approach)
    $funds_with_campaigns = get_posts([
        'post_type' => 'funds',
        'posts_per_page' => -1,
        'post_status' => ['publish', 'draft', 'pending'],
        'meta_query' => [
            [
                'key' => '_gofundme_campaign_id',
                'compare' => 'EXISTS',
            ],
        ],
    ]);

    if (empty($funds_with_campaigns)) {
        // Normal state after architecture pivot - no per-fund campaigns exist
        // Phase 6 will implement master campaign polling for donation totals
        return;
    }

    // ... rest of method unchanged
}
```

**Remove the existing log message on line 217:**
```php
$this->log("Campaign poll: No funds with campaigns found");
```

The method should silently return when no campaigns exist (expected state post-pivot).

**Also remove META_CAMPAIGN_STATUS constant (line 59):**
This constant is only used by sync_campaign_inbound() which stores campaign status.
After the pivot, this meta is orphaned. Remove the constant definition.

**Keep sync_campaign_inbound() method:**
This method is still called for funds that have legacy campaign IDs.
It will continue to update donation totals for those funds until meta is cleaned up.
  </action>
  <verify>
Run: `php -l includes/class-sync-poller.php`
Expect: No syntax errors

Run: `grep -n "META_CAMPAIGN_STATUS" includes/class-sync-poller.php`
Expect: No matches (constant removed)

Run: `grep -n "poll_campaigns" includes/class-sync-poller.php`
Expect: Method still exists with updated logic
  </verify>
  <done>
- poll_campaigns() method updated with silent early return when no funds have campaigns
- Existing log message removed (no longer informative post-pivot)
- META_CAMPAIGN_STATUS constant removed
- sync_campaign_inbound() preserved for legacy funds
- File passes PHP syntax check
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove campaign ID display from admin-ui.php meta box</name>
  <files>includes/class-admin-ui.php</files>
  <action>
Update render_sync_meta_box() method to remove campaign ID display:

**Remove lines 126 and 142-152:**

Line 126:
```php
$campaign_id = get_post_meta($post->ID, '_gofundme_campaign_id', true);
```

Lines 142-152 (entire campaign ID display block):
```php
<p>
    <strong>Campaign ID:</strong><br>
    <?php if ($campaign_id && $org_id): ?>
        <a href="https://www.classy.org/admin/<?php echo esc_attr($org_id); ?>/campaigns/<?php echo esc_attr($campaign_id); ?>" target="_blank">
            <?php echo esc_html($campaign_id); ?> <span class="dashicons dashicons-external"></span>
        </a>
    <?php elseif ($campaign_id): ?>
        <?php echo esc_html($campaign_id); ?> <em>(org ID not configured)</em>
    <?php else: ?>
        <em>Not linked</em>
    <?php endif; ?>
</p>
```

**Keep all other elements:**
- Designation ID display (lines 154-165)
- Last Sync timestamp
- Last Source
- Fundraising Goal input
- Error message display
- Sync Now button

The meta box should now only show designation-related info, not campaign info.
  </action>
  <verify>
Run: `php -l includes/class-admin-ui.php`
Expect: No syntax errors

Run: `grep -n "Campaign ID" includes/class-admin-ui.php`
Expect: No matches in render_sync_meta_box (campaign display removed)

Run: `grep -n "Designation ID" includes/class-admin-ui.php`
Expect: Match found (designation display preserved)
  </verify>
  <done>
- Campaign ID variable removed from meta box
- Campaign ID display block removed
- Designation ID display preserved
- All other meta box functionality unchanged
- File passes PHP syntax check
  </done>
</task>

</tasks>

<verification>
1. Both files pass PHP syntax check
2. Sync poller silently handles empty campaign meta
3. Admin UI meta box shows designation info only
4. Inbound sync polling continues to work for legacy funds
</verification>

<success_criteria>
- poll_campaigns() gracefully handles post-pivot state
- Admin UI no longer displays campaign ID
- Both files pass PHP lint check
- No functional regression in designation sync or donation total polling
</success_criteria>

<output>
After completion, create `.planning/phases/05-code-cleanup/05-02-SUMMARY.md`
</output>
