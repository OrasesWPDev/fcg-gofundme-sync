---
phase: 01-configuration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - includes/class-admin-ui.php
  - fcg-gofundme-sync.php
autonomous: true

user_setup:
  - service: classy-sandbox
    why: "Template campaign must exist for validation"
    note: "Completed in Plan 01"

must_haves:
  truths:
    - "Admin can enter template campaign ID in plugin settings"
    - "Invalid campaign ID is rejected with error message"
    - "Valid campaign ID saves and displays template name"
    - "API unreachable during save triggers background re-validation"
    - "Failed background validation shows admin notice banner"
  artifacts:
    - path: "includes/class-admin-ui.php"
      provides: "Template campaign ID setting registration and validation"
      contains: "fcg_gfm_template_campaign_id"
    - path: "fcg-gofundme-sync.php"
      provides: "Background validation cron hook registration"
      contains: "fcg_gfm_revalidate_template"
  key_links:
    - from: "includes/class-admin-ui.php"
      to: "includes/class-api-client.php"
      via: "get_campaign() for validation"
      pattern: "api->get_campaign"
    - from: "includes/class-admin-ui.php"
      to: "WordPress Options API"
      via: "register_setting with sanitize_callback"
      pattern: "register_setting.*fcg_gfm_template_campaign_id"
---

<objective>
Add template campaign ID setting to existing plugin settings page with API validation.

Purpose: Enables admin to configure which Classy campaign serves as the duplication template for fund campaigns. Validation ensures the ID is valid before campaigns can be created.

Output: Working settings field that stores validated template campaign ID.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-configuration/01-CONTEXT.md
@.planning/phases/01-configuration/01-RESEARCH.md

Key files:
@includes/class-admin-ui.php (settings page at lines 187-284)
@includes/class-api-client.php (get_campaign at line 319)
@fcg-gofundme-sync.php (cron patterns at line 127)

Template campaign ID from Plan 01: Will be in 01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Template Campaign ID Setting with Validation</name>
  <files>includes/class-admin-ui.php</files>
  <action>
  Add template campaign ID setting to FCG_GFM_Admin_UI class:

  1. In register_settings() method (around line 187), add:
     ```php
     register_setting('fcg_gfm_sync', 'fcg_gfm_template_campaign_id', [
         'type' => 'integer',
         'default' => 0,
         'sanitize_callback' => [$this, 'validate_template_campaign_id'],
     ]);
     ```

  2. Add validation method (new method in class):
     ```php
     public function validate_template_campaign_id($input) {
         $input = intval($input);

         // Allow clearing the setting
         if ($input === 0) {
             delete_option('fcg_gfm_template_campaign_name');
             delete_option('fcg_gfm_template_validation_failed');
             return 0;
         }

         $api = new FCG_GFM_API_Client();

         // Check if API is configured first
         if (!$api->is_configured()) {
             add_settings_error(
                 'fcg_gfm_template_campaign_id',
                 'api_not_configured',
                 'Cannot validate template: API credentials not configured.',
                 'error'
             );
             return get_option('fcg_gfm_template_campaign_id', 0);
         }

         $result = $api->get_campaign($input);

         if (!$result['success']) {
             // Check if network/connection issue vs invalid ID
             $error_msg = $result['error'] ?? 'Unknown error';
             $is_connection_error = (
                 stripos($error_msg, 'connection') !== false ||
                 stripos($error_msg, 'timeout') !== false ||
                 stripos($error_msg, 'resolve') !== false ||
                 ($result['http_code'] ?? 0) >= 500
             );

             if ($is_connection_error) {
                 // Schedule background re-validation
                 if (!wp_next_scheduled('fcg_gfm_revalidate_template')) {
                     wp_schedule_single_event(time() + 900, 'fcg_gfm_revalidate_template');
                 }
                 update_option('fcg_gfm_template_validation_pending', true, false);
                 add_settings_error(
                     'fcg_gfm_template_campaign_id',
                     'api_unreachable',
                     'Template ID saved. Could not verify with API (connection issue). Re-validation scheduled.',
                     'warning'
                 );
                 return $input;
             }

             // Invalid ID - block save
             add_settings_error(
                 'fcg_gfm_template_campaign_id',
                 'invalid_id',
                 'Invalid campaign ID: ' . esc_html($error_msg),
                 'error'
             );
             return get_option('fcg_gfm_template_campaign_id', 0);
         }

         // Valid - store campaign name
         $campaign_name = $result['data']['name'] ?? 'Unknown';
         update_option('fcg_gfm_template_campaign_name', $campaign_name, false);
         delete_option('fcg_gfm_template_validation_failed');
         delete_option('fcg_gfm_template_validation_pending');

         add_settings_error(
             'fcg_gfm_template_campaign_id',
             'valid_id',
             'Template campaign validated: ' . esc_html($campaign_name),
             'success'
         );

         return $input;
     }
     ```

  3. In render_settings_page() method (around line 201), add status indicator and field:

     After the opening div.wrap and h1, add status section:
     ```php
     // Status indicator section
     $api = new FCG_GFM_API_Client();
     $api_configured = $api->is_configured();
     $template_id = get_option('fcg_gfm_template_campaign_id', 0);
     $template_name = get_option('fcg_gfm_template_campaign_name', '');
     $validation_failed = get_option('fcg_gfm_template_validation_failed', false);
     $validation_pending = get_option('fcg_gfm_template_validation_pending', false);
     ?>
     <div class="notice notice-<?php echo $api_configured ? 'info' : 'warning'; ?>" style="margin: 15px 0;">
         <p>
             <strong>API Status:</strong>
             <?php if ($api_configured): ?>
                 <span style="color: #46b450;">Connected</span>
             <?php else: ?>
                 <span style="color: #dc3232;">Not Configured</span>
             <?php endif; ?>

             <?php if ($template_id && $template_name && !$validation_failed && !$validation_pending): ?>
                 &nbsp;|&nbsp; <strong>Template:</strong> <?php echo esc_html($template_name); ?>
                 <span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span>
             <?php elseif ($template_id && $validation_pending): ?>
                 &nbsp;|&nbsp; <strong>Template:</strong> Validation pending
                 <span class="dashicons dashicons-clock" style="color: #f0b849;"></span>
             <?php elseif ($template_id && $validation_failed): ?>
                 &nbsp;|&nbsp; <strong>Template:</strong> Validation failed
                 <span class="dashicons dashicons-warning" style="color: #dc3232;"></span>
             <?php endif; ?>
         </p>
     </div>
     <?php
     ```

     In the form-table, add new row BEFORE the Auto-Polling row:
     ```php
     <tr>
         <th scope="row">Template Campaign ID</th>
         <td>
             <input type="number"
                    name="fcg_gfm_template_campaign_id"
                    value="<?php echo esc_attr($template_id); ?>"
                    class="regular-text"
                    min="0"
                    step="1">
             <?php if ($template_name && !$validation_failed): ?>
                 <p class="description" style="color: #46b450;">
                     <span class="dashicons dashicons-yes"></span>
                     Template: <?php echo esc_html($template_name); ?>
                 </p>
             <?php endif; ?>
             <p class="description">
                 Enter the campaign ID to use as template for fund campaigns.
                 <a href="https://www.classy.org/admin/campaigns" target="_blank">
                     Find campaign ID in Classy <span class="dashicons dashicons-external"></span>
                 </a>
             </p>
         </td>
     </tr>
     ```

  Follow existing code style: PSR-12, WordPress conventions, existing method patterns in class.
  </action>
  <verify>
  SSH to staging and test via WP-CLI:
  ```bash
  ssh frederickc2stg@frederickc2stg.ssh.wpengine.net
  cd ~/sites/frederickc2stg/wp-content/plugins/fcg-gofundme-sync

  # Verify setting is registered
  wp option get fcg_gfm_template_campaign_id 2>/dev/null || echo "Not set yet"

  # Test setting a value (will fail validation without valid ID)
  wp option update fcg_gfm_template_campaign_id 0
  ```
  </verify>
  <done>
  - fcg_gfm_template_campaign_id setting registered with sanitize_callback
  - validate_template_campaign_id method validates against Classy API
  - Status indicator shows API and template validation state
  - Settings field renders with helper link
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Background Re-validation Cron Hook</name>
  <files>fcg-gofundme-sync.php, includes/class-admin-ui.php</files>
  <action>
  1. In fcg-gofundme-sync.php, register the cron hook in the plugin initialization:

     Find where other hooks are registered (around line 127) and add:
     ```php
     // Background template validation
     add_action('fcg_gfm_revalidate_template', ['FCG_GFM_Admin_UI', 'revalidate_template_campaign']);
     ```

  2. In includes/class-admin-ui.php, add static method for background validation:
     ```php
     /**
      * Background re-validation of template campaign ID
      * Called via WP-Cron when API was unreachable during initial validation
      */
     public static function revalidate_template_campaign(): void {
         $template_id = get_option('fcg_gfm_template_campaign_id', 0);
         if (!$template_id) {
             delete_option('fcg_gfm_template_validation_failed');
             delete_option('fcg_gfm_template_validation_pending');
             return;
         }

         $api = new FCG_GFM_API_Client();
         if (!$api->is_configured()) {
             update_option('fcg_gfm_template_validation_failed', true, false);
             delete_option('fcg_gfm_template_validation_pending');
             return;
         }

         $result = $api->get_campaign($template_id);

         if (!$result['success']) {
             update_option('fcg_gfm_template_validation_failed', true, false);
             delete_option('fcg_gfm_template_validation_pending');

             if (defined('WP_DEBUG') && WP_DEBUG) {
                 error_log('[FCG GoFundMe Sync] Background template validation failed: ' . ($result['error'] ?? 'Unknown error'));
             }
         } else {
             // Success
             update_option('fcg_gfm_template_campaign_name', $result['data']['name'] ?? 'Unknown', false);
             delete_option('fcg_gfm_template_validation_failed');
             delete_option('fcg_gfm_template_validation_pending');

             if (defined('WP_DEBUG') && WP_DEBUG) {
                 error_log('[FCG GoFundMe Sync] Background template validation succeeded: ' . ($result['data']['name'] ?? 'Unknown'));
             }
         }
     }
     ```

  3. In includes/class-admin-ui.php show_sync_notices() method, add check for template validation failure:

     At the beginning of the method (after the screen check), add:
     ```php
     // Check for template validation failure (show on all admin pages)
     if (get_option('fcg_gfm_template_validation_failed')) {
         printf(
             '<div class="notice notice-error is-dismissible"><p><strong>GoFundMe Pro Sync:</strong> Template campaign ID validation failed. <a href="%s">Check settings</a></p></div>',
             esc_url(admin_url('edit.php?post_type=funds&page=fcg-gfm-sync-settings'))
         );
     }
     ```
     Move this BEFORE the existing screen check so it shows on all admin pages.

  Follow existing cron registration pattern in fcg-gofundme-sync.php.
  </action>
  <verify>
  SSH to staging and verify:
  ```bash
  ssh frederickc2stg@frederickc2stg.ssh.wpengine.net
  cd ~/sites/frederickc2stg

  # Check if cron hook is registered
  wp cron event list | grep revalidate_template

  # Test running the cron manually (will do nothing if no template ID set)
  wp cron event run fcg_gfm_revalidate_template 2>/dev/null || echo "No event scheduled"
  ```
  </verify>
  <done>
  - fcg_gfm_revalidate_template cron hook registered
  - revalidate_template_campaign static method handles background validation
  - Admin notice shows when background validation fails
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Settings UI Works</name>
  <what-built>
  - Template campaign ID setting field on settings page
  - API and template status indicator
  - Validation on save (valid/invalid/unreachable handling)
  </what-built>
  <how-to-verify>
  1. Visit staging site: https://frederickc2stg.wpengine.net/wp-admin/
  2. Navigate to: Funds > Sync Settings
  3. Verify you see:
     - API Status indicator (should show "Connected" if env vars configured)
     - Template Campaign ID field with helper link
  4. Enter the template campaign ID from Plan 01 (from 01-01-SUMMARY.md)
  5. Click Save Changes
  6. Verify:
     - Success message shows template name
     - Status indicator updates to show template validated
  7. Try entering an invalid ID (e.g., 99999999)
  8. Verify error message appears and old value is preserved
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
All verification via staging environment:
- `wp option get fcg_gfm_template_campaign_id` returns expected value
- `wp option get fcg_gfm_template_campaign_name` returns campaign name
- Settings page displays field and status correctly
- Validation works for valid/invalid IDs
</verification>

<success_criteria>
- CONF-01 requirement satisfied: Admin can configure template campaign ID
- Template ID validated against Classy API on save
- Background re-validation scheduled when API unreachable
- Admin notice shown when validation fails
</success_criteria>

<output>
After completion, create `.planning/phases/01-configuration/01-02-SUMMARY.md`
</output>
