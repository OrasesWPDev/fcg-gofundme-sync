---
phase: 01-configuration
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - includes/class-admin-ui.php
autonomous: true

must_haves:
  truths:
    - "Fundraising goal field appears on fund edit screen"
    - "Goal value saves when fund is saved"
    - "Goal accepts both 5000 and 5,000 as valid input"
    - "Goal is stored as integer in post meta"
  artifacts:
    - path: "includes/class-admin-ui.php"
      provides: "Fundraising goal field rendering and save handler"
      contains: "_gofundme_fundraising_goal"
  key_links:
    - from: "includes/class-admin-ui.php"
      to: "WordPress Post Meta API"
      via: "update_post_meta in save_post_funds hook"
      pattern: "update_post_meta.*_gofundme_fundraising_goal"
---

<objective>
Add fundraising goal field to the existing GoFundMe Pro Sync meta box on fund edit screen.

Purpose: Enables setting per-fund fundraising goals that will be pushed to Classy campaigns in Phase 2. This is per-fund data (unlike template ID which is global).

Output: Working goal field that saves to post meta.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-configuration/01-CONTEXT.md
@.planning/phases/01-configuration/01-RESEARCH.md
@.planning/phases/01-configuration/01-02-SUMMARY.md

Key files:
@includes/class-admin-ui.php (meta box at lines 105-168, nonce at line 127)

Decisions from CONTEXT.md:
- Add to existing sync status meta box (not a new meta box)
- Currency-formatted input: $ prefix, comma formatting
- Store as integer in post meta: _gofundme_fundraising_goal
- Goal is optional (campaigns can be created without a goal)

Note: This plan runs after Plan 02 because both modify class-admin-ui.php.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Fundraising Goal Field to Meta Box</name>
  <files>includes/class-admin-ui.php</files>
  <action>
  Modify FCG_GFM_Admin_UI class to add fundraising goal field:

  1. In render_sync_meta_box() method (around line 121), add goal field.

     After retrieving existing meta values (around line 125), add:
     ```php
     $fundraising_goal = get_post_meta($post->ID, '_gofundme_fundraising_goal', true);
     ```

     After the "Last Source" paragraph (around line 149) and BEFORE the error message check, add:
     ```php
     <p>
         <label for="fcg-fundraising-goal"><strong>Fundraising Goal:</strong></label><br>
         <span style="display: inline-flex; align-items: center;">
             <span style="margin-right: 4px;">$</span>
             <input type="text"
                    id="fcg-fundraising-goal"
                    name="fcg_fundraising_goal"
                    value="<?php echo esc_attr($fundraising_goal ? number_format((int) $fundraising_goal) : ''); ?>"
                    placeholder="e.g., 5,000"
                    class="regular-text"
                    style="width: 120px;"
                    inputmode="numeric">
         </span>
         <p class="description" style="margin-top: 4px;">Optional. Goal amount for this fund's campaign.</p>
     </p>
     ```

  2. In constructor (around line 19), add save hook:
     ```php
     // Save fundraising goal
     add_action('save_post_funds', [$this, 'save_fundraising_goal'], 10, 2);
     ```

  3. Add new method to save the goal:
     ```php
     /**
      * Save fundraising goal from meta box
      *
      * @param int $post_id Post ID
      * @param WP_Post $post Post object
      */
     public function save_fundraising_goal(int $post_id, WP_Post $post): void {
         // Check nonce (uses same nonce as sync meta box)
         if (!isset($_POST['fcg_gfm_sync_nonce']) ||
             !wp_verify_nonce($_POST['fcg_gfm_sync_nonce'], 'fcg_gfm_sync_now')) {
             return;
         }

         // Check autosave
         if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
             return;
         }

         // Check permissions
         if (!current_user_can('edit_post', $post_id)) {
             return;
         }

         // Process fundraising goal
         if (isset($_POST['fcg_fundraising_goal'])) {
             $goal = sanitize_text_field($_POST['fcg_fundraising_goal']);
             // Remove commas and non-numeric characters (except decimal point)
             $goal = preg_replace('/[^0-9.]/', '', $goal);

             if (is_numeric($goal) && floatval($goal) > 0) {
                 // Store as integer (cents would require different handling)
                 update_post_meta($post_id, '_gofundme_fundraising_goal', intval(floatval($goal)));
             } else {
                 // Empty or invalid - remove the meta
                 delete_post_meta($post_id, '_gofundme_fundraising_goal');
             }
         }
     }
     ```

  Note: The existing nonce field (line 127) is already named 'fcg_gfm_sync_nonce' with action 'fcg_gfm_sync_now'. Reuse this for the goal field save.

  Follow existing code patterns in the file.
  </action>
  <verify>
  SSH to staging and verify:
  ```bash
  ssh frederickc2stg@frederickc2stg.ssh.wpengine.net
  cd ~/sites/frederickc2stg

  # Get a fund post ID
  FUND_ID=$(wp post list --post_type=funds --posts_per_page=1 --format=ids)
  echo "Testing with fund ID: $FUND_ID"

  # Check if meta key exists (may not exist yet)
  wp post meta get $FUND_ID _gofundme_fundraising_goal 2>/dev/null || echo "Not set yet"

  # Set a test value directly
  wp post meta update $FUND_ID _gofundme_fundraising_goal 5000
  wp post meta get $FUND_ID _gofundme_fundraising_goal

  # Clean up test value
  wp post meta delete $FUND_ID _gofundme_fundraising_goal
  ```
  </verify>
  <done>
  - Fundraising goal field renders in meta box with $ prefix
  - save_post_funds hook added for saving goal
  - save_fundraising_goal method handles input sanitization
  - Goal stored as integer in _gofundme_fundraising_goal meta key
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Goal Field Works in Admin UI</name>
  <what-built>
  - Fundraising goal field in GoFundMe Pro Sync meta box
  - Currency formatting with $ prefix
  - Save handling that accepts both "5000" and "5,000"
  </what-built>
  <how-to-verify>
  1. Visit staging site: https://frederickc2stg.wpengine.net/wp-admin/
  2. Navigate to: Funds > All Funds
  3. Edit any fund post
  4. In the "GoFundMe Pro Sync" meta box (right sidebar), verify:
     - "Fundraising Goal:" field appears with $ prefix
     - Field has placeholder "e.g., 5,000"
  5. Enter a goal: 10000 (or 10,000)
  6. Click Update/Publish
  7. Refresh the page
  8. Verify:
     - Goal shows as "10,000" (formatted with comma)
     - Value persisted correctly
  9. Try clearing the goal (empty field) and save
  10. Verify goal is removed (field shows empty)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
All verification via staging environment:
- Fund edit screen shows Fundraising Goal field in meta box
- Saving a fund stores goal in _gofundme_fundraising_goal meta
- Input accepts both "5000" and "5,000" formats
- Stored value is integer (verified via WP-CLI)
</verification>

<success_criteria>
- CONF-02 requirement satisfied: fundraising_goal field added to funds
- Goal field exists on fund edit screen
- Goal value is saved with fund post meta
</success_criteria>

<output>
After completion, create `.planning/phases/01-configuration/01-03-SUMMARY.md`
</output>
