---
phase: 02-campaign-push-sync
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - includes/class-sync-handler.php
autonomous: true

must_haves:
  truths:
    - "When fund is restored from trash, campaign is reactivated then published"
    - "Restored campaigns return to active status (not just unpublished)"
    - "Fund sync can be explicitly disabled via ACF checkbox"
  artifacts:
    - path: "includes/class-sync-handler.php"
      provides: "Campaign restore workflow and sync opt-out"
      contains: "reactivate_campaign"
  key_links:
    - from: "on_untrash_fund()"
      to: "FCG_GFM_API_Client::reactivate_campaign()"
      via: "$this->api->reactivate_campaign()"
      pattern: "reactivate_campaign"
    - from: "on_untrash_fund()"
      to: "FCG_GFM_API_Client::publish_campaign()"
      via: "$this->api->publish_campaign()"
      pattern: "publish_campaign"
    - from: "sync_campaign_to_gofundme()"
      to: "should_sync_campaign()"
      via: "method call"
      pattern: "should_sync_campaign.*post_id"
---

<objective>
Fix campaign restore workflow and add sync opt-out mechanism.

Purpose: The current `on_untrash_fund()` only calls update_campaign(), but restoring a deactivated campaign requires reactivate() then publish(). Also need ACF checkbox to allow explicit fund exclusion from campaign sync.

Output: Updated restore handler with proper reactivate-then-publish sequence, and should_sync_campaign() check.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-campaign-push-sync/02-RESEARCH.md
@.planning/phases/02-campaign-push-sync/02-01-SUMMARY.md
@includes/class-sync-handler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add should_sync_campaign() method and update sync_campaign_to_gofundme()</name>
  <files>includes/class-sync-handler.php</files>
  <action>
1. Add a new private method `should_sync_campaign()` near the other helper methods (after `get_campaign_url()` around line 468):

```php
/**
 * Check if campaign sync is enabled for this fund
 *
 * @param int $post_id Post ID
 * @return bool True if campaign should be synced
 */
private function should_sync_campaign(int $post_id): bool {
    // Check if ACF is available
    if (!function_exists('get_field')) {
        return true; // Default to sync if ACF not available
    }

    $gfm_settings = get_field(self::ACF_GROUP_KEY, $post_id);

    // Check for explicit disable
    if (!empty($gfm_settings['disable_campaign_sync'])) {
        return false;
    }

    return true;
}
```

2. Update `sync_campaign_to_gofundme()` (around line 435) to check this method at the start:

Add as the first lines after the method signature:
```php
// Check if campaign sync is disabled for this fund
if (!$this->should_sync_campaign($post_id)) {
    return;
}
```

This allows funds to opt-out of campaign sync while still syncing designations.
  </action>
  <verify>
`php -l includes/class-sync-handler.php` returns no errors
`grep -c "should_sync_campaign" includes/class-sync-handler.php` returns at least 2 (definition + call)
`grep -c "disable_campaign_sync" includes/class-sync-handler.php` returns at least 1
  </verify>
  <done>
- should_sync_campaign() method added
- sync_campaign_to_gofundme() checks should_sync_campaign() before proceeding
- Funds with disable_campaign_sync ACF field enabled will skip campaign operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Update on_untrash_fund() for proper campaign restore</name>
  <files>includes/class-sync-handler.php</files>
  <action>
Update the campaign section of `on_untrash_fund()` (around lines 201-209) to use the proper reactivate-then-publish sequence:

Replace the existing campaign handling code:
```php
// Update campaign (attempt reactivation via update)
$campaign_id = $this->get_campaign_id($post_id);
if ($campaign_id) {
    $campaign_data = $this->build_campaign_data($post);
    $result = $this->api->update_campaign($campaign_id, $campaign_data);
    if ($result['success']) {
        $this->log_info("Updated campaign {$campaign_id} for restored post {$post_id}");
    }
}
```

With:
```php
// Reactivate and publish campaign
$campaign_id = $this->get_campaign_id($post_id);
if ($campaign_id && $this->should_sync_campaign($post_id)) {
    // Step 1: Reactivate (returns campaign to unpublished status)
    $reactivate_result = $this->api->reactivate_campaign($campaign_id);
    if (!$reactivate_result['success']) {
        $this->log_error("Failed to reactivate campaign {$campaign_id}: " . ($reactivate_result['error'] ?? 'Unknown error'));
        return;
    }
    $this->log_info("Reactivated campaign {$campaign_id} for restored post {$post_id}");

    // Step 2: Publish (makes campaign active again)
    $publish_result = $this->api->publish_campaign($campaign_id);
    if (!$publish_result['success']) {
        $this->log_error("Failed to publish campaign {$campaign_id} after reactivation: " . ($publish_result['error'] ?? 'Unknown error'));
        // Campaign is reactivated but unpublished - not ideal but recoverable
    } else {
        $this->log_info("Published campaign {$campaign_id} for restored post {$post_id}");
    }

    // Step 3: Update campaign data (name, goal, overview may have changed)
    $campaign_data = $this->build_campaign_data($post);
    $update_result = $this->api->update_campaign($campaign_id, $campaign_data);
    if ($update_result['success']) {
        update_post_meta($post_id, self::META_KEY_LAST_SYNC, current_time('mysql'));
        $this->log_info("Updated campaign {$campaign_id} data for restored post {$post_id}");
    }
}
```

The sequence is:
1. Reactivate: deactivated -> unpublished
2. Publish: unpublished -> active
3. Update: sync any data changes made while trashed
  </action>
  <verify>
`php -l includes/class-sync-handler.php` returns no errors
`grep -c "reactivate_campaign" includes/class-sync-handler.php` returns at least 1
`grep "Reactivated campaign" includes/class-sync-handler.php` shows the log message exists
  </verify>
  <done>
on_untrash_fund() updated to:
- Check should_sync_campaign() before proceeding
- Call reactivate_campaign() to return from deactivated to unpublished
- Call publish_campaign() to make campaign active
- Call update_campaign() to sync any data changes
- Proper error handling and logging for each step
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy and test restore workflow on staging</name>
  <files>includes/class-sync-handler.php</files>
  <action>
1. Deploy updated plugin to staging:
   ```bash
   rsync -avz --exclude='.git' --exclude='.planning' \
     /Users/chadmacbook/projects/fcg/ \
     frederickc2stg@frederickc2stg.ssh.wpengine.net:~/sites/frederickc2stg/wp-content/plugins/fcg-gofundme-sync/
   ```

2. SSH to staging and set up test:
   ```bash
   ssh frederickc2stg@frederickc2stg.ssh.wpengine.net
   cd ~/sites/frederickc2stg

   # Create a test fund
   POST_ID=$(wp post create --post_type=funds \
     --post_title="Restore Test Fund $(date +%s)" \
     --post_content="Testing trash/restore workflow." \
     --post_status=publish \
     --porcelain)
   echo "Created fund: $POST_ID"

   # Get campaign ID
   CAMPAIGN_ID=$(wp post meta get $POST_ID _gofundme_campaign_id)
   echo "Campaign ID: $CAMPAIGN_ID"
   ```

3. Verify initial state:
   ```bash
   wp eval "
   \$api = new FCG_GFM_API_Client();
   \$result = \$api->get_campaign($CAMPAIGN_ID);
   echo 'Before trash - Status: ' . \$result['data']['status'] . '\n';
   "
   ```

4. Trash the fund and verify campaign deactivated:
   ```bash
   wp post update $POST_ID --post_status=trash

   wp eval "
   \$api = new FCG_GFM_API_Client();
   \$result = \$api->get_campaign($CAMPAIGN_ID);
   echo 'After trash - Status: ' . \$result['data']['status'] . '\n';
   "
   ```

5. Restore the fund and verify campaign reactivated and published:
   ```bash
   # Restore from trash
   wp post update $POST_ID --post_status=publish

   wp eval "
   \$api = new FCG_GFM_API_Client();
   \$result = \$api->get_campaign($CAMPAIGN_ID);
   echo 'After restore - Status: ' . \$result['data']['status'] . '\n';
   "
   ```

6. Clean up:
   ```bash
   wp post delete $POST_ID --force
   ```

Expected results:
- Before trash: status = "active"
- After trash: status = "deactivated"
- After restore: status = "active" (not "unpublished")
  </action>
  <verify>
Campaign status transitions correctly:
- active -> deactivated (on trash)
- deactivated -> active (on restore, via reactivate + publish)
  </verify>
  <done>
Restore workflow verified on staging:
- Trashing fund deactivates campaign
- Restoring fund reactivates and publishes campaign
- Campaign returns to active status (not stuck at unpublished)
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-sync-handler.php` passes
2. should_sync_campaign() method exists and is called from sync_campaign_to_gofundme()
3. on_untrash_fund() calls reactivate_campaign() then publish_campaign()
4. Staging test: trash/restore cycle results in campaign returning to active status
</verification>

<success_criteria>
- should_sync_campaign() allows opt-out via ACF field
- on_untrash_fund() uses reactivate-then-publish sequence
- Restored campaigns return to "active" status (not "unpublished")
- Sync opt-out mechanism ready for ACF field (field added via ACF admin UI)
</success_criteria>

<output>
After completion, create `.planning/phases/02-campaign-push-sync/02-03-SUMMARY.md`
</output>
