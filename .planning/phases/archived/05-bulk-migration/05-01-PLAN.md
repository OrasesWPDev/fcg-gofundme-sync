---
phase: 05-bulk-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-migration-command.php
  - includes/class-sync-handler.php
  - fcg-gofundme-sync.php
autonomous: true

must_haves:
  truths:
    - "Admin can run wp fcg-gfm migrate-campaigns --help and see usage info"
    - "Dry-run mode lists funds that would be migrated without creating campaigns"
    - "Live mode creates campaigns for funds without campaign_id"
    - "Migration can resume from a specific page if interrupted"
    - "Success/failure summary displayed after migration completes"
    - "Funds with disable_campaign_sync are skipped"
  artifacts:
    - path: "includes/class-migration-command.php"
      provides: "WP-CLI migration command class"
      min_lines: 150
    - path: "fcg-gofundme-sync.php"
      provides: "WP-CLI command registration"
      contains: "WP_CLI::add_command"
  key_links:
    - from: "includes/class-migration-command.php"
      to: "includes/class-sync-handler.php"
      via: "create_campaign_in_gfm() method call"
      pattern: "create_campaign_in_gfm"
    - from: "fcg-gofundme-sync.php"
      to: "includes/class-migration-command.php"
      via: "require_once and WP_CLI::add_command"
      pattern: "class-migration-command"
---

<objective>
Implement WP-CLI bulk migration command for existing funds

Purpose: 758 existing published funds need GoFundMe Pro campaigns created. Manual creation is impractical - a batch migration tool enables automated, resumable, observable migration.

Output: Working WP-CLI command that creates campaigns for all funds lacking campaign_id, with dry-run mode, batch processing, progress bar, and resume capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bulk-migration/05-RESEARCH.md

# Existing code to reference
@includes/class-sync-handler.php
@includes/class-api-client.php
@fcg-gofundme-sync.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WP-CLI migration command class</name>
  <files>
    includes/class-migration-command.php
    includes/class-sync-handler.php
  </files>
  <action>
Create new file `includes/class-migration-command.php` with `FCG_GFM_Migration_Command` class:

1. **Class structure with PHPDoc synopsis:**
   - Document all options: `--batch-size=<number>` (default 50), `--page=<number>` (default 1), `--live`, `--throttle=<seconds>` (default 1)
   - Include `@when after_wp_load` annotation
   - Add example usage in PHPDoc

2. **Constructor:**
   - Store reference to FCG_GFM_Sync_Handler instance
   - Store reference to FCG_GFM_API_Client instance

3. **Main method `migrate_campaigns($args, $assoc_args)`:**

   a. **Lock check** - Prevent concurrent runs:
      - Check for transient `fcg_gfm_migration_lock`
      - If exists and not `--force`, error with "Migration already in progress"
      - Set lock transient with 2-hour TTL
      - Delete lock on completion (in finally block pattern)

   b. **Prerequisites check:**
      - Verify template campaign ID is configured (`get_option('fcg_gfm_template_campaign_id')`)
      - If missing, `WP_CLI::error()` with clear message

   c. **Dry-run mode detection:**
      - Default to dry-run unless `--live` flag present
      - Log warning when in dry-run mode
      - Log warning when in live mode

   d. **Query funds needing migration:**
      - Use WP_Query with these args:
        ```php
        $query_args = [
            'post_type'      => 'funds',
            'post_status'    => 'publish',
            'posts_per_page' => $batch_size,
            'paged'          => $page,
            'orderby'        => 'ID',
            'order'          => 'ASC',
            'meta_query'     => [
                'relation' => 'AND',
                [
                    'key'     => '_gofundme_campaign_id',
                    'compare' => 'NOT EXISTS',
                ],
                [
                    'relation' => 'OR',
                    [
                        'key'     => 'gofundme_settings_disable_campaign_sync',
                        'compare' => 'NOT EXISTS',
                    ],
                    [
                        'key'     => 'gofundme_settings_disable_campaign_sync',
                        'value'   => '1',
                        'compare' => '!=',
                    ],
                ],
            ],
            'no_found_rows'  => false,  // Need total for progress
        ];
        ```
      - If no posts found, `WP_CLI::success("No funds without campaigns found.")` and return

   e. **Progress bar:**
      - Create with `\WP_CLI\Utils\make_progress_bar('Migrating campaigns', $query->post_count)`

   f. **Process loop with error tolerance:**
      - For each post in query:
        - If dry-run: `WP_CLI::log("[DRY RUN] Would create campaign for: {$post_id} - {$title}")`, tick, continue
        - If live: Call `$this->sync_handler->create_campaign_in_gfm($post_id, $campaign_data)`
        - Verify campaign was created by checking `get_post_meta($post_id, '_gofundme_campaign_id', true)`
        - Track successes and failures with context (post_id, title, error message)
        - Tick progress bar
        - Sleep for throttle seconds between requests (skip on last item)
        - Catch exceptions, log to failures array, continue

   g. **Summary output:**
      - Finish progress bar
      - Log success count with `WP_CLI::success()`
      - If failures, log each with `WP_CLI::warning()` showing post ID, title, error
      - Log total processed, skipped (sync disabled), succeeded, failed
      - If more pages exist, log "Resume with --page={next_page}" hint

4. **Helper method `build_campaign_data_for_migration($post)`:**
   - Replicate logic from FCG_GFM_Sync_Handler::build_campaign_data()
   - Return array with name, goal, started_at, overview, external_reference_id

5. **Make `create_campaign_in_gfm()` accessible:**
   - In `includes/class-sync-handler.php`, change line 479 from:
     `private function create_campaign_in_gfm(int $post_id, array $data): void`
   - To:
     `public function create_campaign_in_gfm(int $post_id, array $data): void`
   - This is a one-line change (private -> public)

**Implementation notes:**
- Use `WP_CLI::log()` for informational output (not echo)
- Use `WP_CLI::warning()` for non-fatal issues
- Use `WP_CLI::error()` only for fatal issues that should stop execution
- Use `WP_CLI::success()` for completion messages
- Handle memory cleanup with `wp_cache_flush()` every 50 items if needed
  </action>
  <verify>
Run syntax check on new file:
```bash
php -l includes/class-migration-command.php
```
Verify no errors.
  </verify>
  <done>
- `includes/class-migration-command.php` exists with FCG_GFM_Migration_Command class
- Class has `migrate_campaigns` method with full PHPDoc synopsis
- Implements: lock check, dry-run default, WP_Query pagination, progress bar, error tracking, summary output
- `includes/class-sync-handler.php` has `create_campaign_in_gfm` as public method
  </done>
</task>

<task type="auto">
  <name>Task 2: Register WP-CLI command and deploy to staging</name>
  <files>
    fcg-gofundme-sync.php
  </files>
  <action>
1. **Add WP-CLI command registration to main plugin file:**

   After the existing require_once statements (around line 39), add:
   ```php
   // Load WP-CLI migration command (only when WP-CLI is active)
   if (defined('WP_CLI') && WP_CLI) {
       require_once FCG_GFM_SYNC_PATH . 'includes/class-migration-command.php';
       WP_CLI::add_command('fcg-gfm', 'FCG_GFM_Migration_Command');
   }
   ```

2. **Bump plugin version:**
   - Change version from 2.2.0 to 2.3.0 in:
     - Line 7: `Version: 2.3.0`
     - Line 24: `define('FCG_GFM_SYNC_VERSION', '2.3.0');`

3. **Deploy to staging:**
   ```bash
   rsync -avz --exclude='.git' --exclude='.planning' --exclude='*.zip' \
     /Users/chadmacbook/projects/fcg/ \
     frederickc2stg@frederickc2stg.ssh.wpengine.net:~/sites/frederickc2stg/wp-content/plugins/fcg-gofundme-sync/
   ```

4. **Test WP-CLI command availability on staging:**
   ```bash
   ssh frederickc2stg@frederickc2stg.ssh.wpengine.net "cd ~/sites/frederickc2stg && wp fcg-gfm migrate-campaigns --help"
   ```

5. **Run dry-run test on staging:**
   ```bash
   ssh frederickc2stg@frederickc2stg.ssh.wpengine.net "cd ~/sites/frederickc2stg && wp fcg-gfm migrate-campaigns --batch-size=5"
   ```
   This should list up to 5 funds that would be migrated without actually creating campaigns.

**Do NOT run with --live flag yet** - that requires user approval before migrating real data.
  </action>
  <verify>
1. Verify command is registered:
```bash
ssh frederickc2stg@frederickc2stg.ssh.wpengine.net "cd ~/sites/frederickc2stg && wp fcg-gfm migrate-campaigns --help"
```
Expected: Help text showing all options (--batch-size, --page, --live, --throttle)

2. Verify dry-run works:
```bash
ssh frederickc2stg@frederickc2stg.ssh.wpengine.net "cd ~/sites/frederickc2stg && wp fcg-gfm migrate-campaigns --batch-size=3"
```
Expected: "[DRY RUN]" prefix on each fund, summary at end, no campaigns created
  </verify>
  <done>
- WP-CLI command `wp fcg-gfm migrate-campaigns` is available on staging
- `--help` displays all options with defaults
- Dry-run mode lists funds without creating campaigns
- Plugin version is 2.3.0
  </done>
</task>

</tasks>

<verification>
## Phase 5 Requirements Verification

| Requirement | Check | Command |
|-------------|-------|---------|
| MIGR-01 | Command creates campaigns | `wp fcg-gfm migrate-campaigns --live --batch-size=1` (creates 1) |
| MIGR-02 | Batch processing works | `wp fcg-gfm migrate-campaigns --batch-size=50` |
| MIGR-03 | Resumable via page | `wp fcg-gfm migrate-campaigns --page=2` |
| MIGR-04 | Dry-run mode | `wp fcg-gfm migrate-campaigns` (no --live flag) |
| MIGR-05 | Logs success/failure | Check output summary after any run |

## Final Verification (requires user approval)

After dry-run testing confirms correct behavior, user can approve live migration:
```bash
ssh frederickc2stg@frederickc2stg.ssh.wpengine.net "cd ~/sites/frederickc2stg && wp fcg-gfm migrate-campaigns --live --batch-size=50"
```

Monitor output for:
- Progress bar advancement
- No error messages
- Success count matches expected
- API rate limit not exceeded (watch for timeouts)
</verification>

<success_criteria>
1. `wp fcg-gfm migrate-campaigns --help` shows usage with all options
2. Dry-run mode (default) lists funds without creating campaigns
3. `--live` flag creates campaigns for funds without campaign_id
4. `--page=N` allows resuming from a specific batch
5. `--batch-size=N` controls how many funds per batch
6. `--throttle=N` controls delay between API calls
7. Progress bar shows advancement during processing
8. Summary shows success/failure counts after completion
9. Funds with `disable_campaign_sync` are skipped
</success_criteria>

<output>
After completion, create `.planning/phases/05-bulk-migration/05-01-SUMMARY.md`
</output>
