---
phase: 02-campaign-push-sync
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified: []
autonomous: false
user_setup:
  - service: acf
    why: "Campaign sync opt-out checkbox"
    dashboard_config:
      - task: "Add disable_campaign_sync checkbox field to gofundme_settings field group"
        location: "WordPress Admin -> ACF -> Field Groups -> GoFundMe Settings"

must_haves:
  truths:
    - "Fund publish creates campaign with correct name and goal"
    - "Fund update syncs changes to existing campaign"
    - "Fund trash deactivates campaign"
    - "Fund restore reactivates and publishes campaign"
    - "Campaign ID and URL visible in fund meta box"
    - "Disable Campaign Sync checkbox prevents campaign operations"
  artifacts:
    - path: "WordPress admin"
      provides: "ACF field for disable_campaign_sync"
  key_links:
    - from: "Fund edit screen"
      to: "_gofundme_campaign_id post meta"
      via: "on_save_fund() sync"
      pattern: "campaign_id"
---

<objective>
End-to-end verification of campaign push sync and ACF field setup.

Purpose: Confirm all Phase 2 requirements work together: create, update, trash, restore, and opt-out. Also configure the ACF checkbox field for explicit fund exclusion.

Output: Verified campaign sync workflow and configured ACF field.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-campaign-push-sync/02-RESEARCH.md
@.planning/phases/02-campaign-push-sync/02-02-SUMMARY.md
@.planning/phases/02-campaign-push-sync/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full lifecycle test on staging</name>
  <files></files>
  <action>
Run comprehensive end-to-end test on staging environment.

1. SSH to staging:
   ```bash
   ssh frederickc2stg@frederickc2stg.ssh.wpengine.net
   cd ~/sites/frederickc2stg
   ```

2. Create test fund with goal:
   ```bash
   POST_ID=$(wp post create --post_type=funds \
     --post_title="E2E Test Fund $(date +%s)" \
     --post_content="End-to-end campaign sync test." \
     --post_status=publish \
     --porcelain)
   echo "Created fund: $POST_ID"

   # Set fundraising goal
   wp post meta update $POST_ID _gofundme_fundraising_goal 5000
   ```

3. Verify campaign created with correct data:
   ```bash
   CAMPAIGN_ID=$(wp post meta get $POST_ID _gofundme_campaign_id)
   CAMPAIGN_URL=$(wp post meta get $POST_ID _gofundme_campaign_url)
   echo "Campaign ID: $CAMPAIGN_ID"
   echo "Campaign URL: $CAMPAIGN_URL"

   wp eval "
   \$api = new FCG_GFM_API_Client();
   \$result = \$api->get_campaign($CAMPAIGN_ID);
   \$d = \$result['data'];
   echo 'Name: ' . \$d['name'] . '\n';
   echo 'Status: ' . \$d['status'] . '\n';
   echo 'Goal: ' . \$d['raw_goal'] . '\n';
   "
   ```

4. Update fund and verify sync:
   ```bash
   wp post update $POST_ID --post_title="Updated E2E Fund $(date +%s)"
   wp post meta update $POST_ID _gofundme_fundraising_goal 7500

   # Trigger sync by touching the post
   wp eval "do_action('save_post_funds', $POST_ID, get_post($POST_ID), true);"

   wp eval "
   \$api = new FCG_GFM_API_Client();
   \$result = \$api->get_campaign($CAMPAIGN_ID);
   echo 'Updated Name: ' . \$result['data']['name'] . '\n';
   echo 'Updated Goal: ' . \$result['data']['raw_goal'] . '\n';
   "
   ```

5. Test trash (deactivate):
   ```bash
   wp post update $POST_ID --post_status=trash

   wp eval "
   \$api = new FCG_GFM_API_Client();
   \$result = \$api->get_campaign($CAMPAIGN_ID);
   echo 'After Trash Status: ' . \$result['data']['status'] . '\n';
   "
   ```

6. Test restore (reactivate + publish):
   ```bash
   wp post update $POST_ID --post_status=publish

   wp eval "
   \$api = new FCG_GFM_API_Client();
   \$result = \$api->get_campaign($CAMPAIGN_ID);
   echo 'After Restore Status: ' . \$result['data']['status'] . '\n';
   "
   ```

7. Clean up test fund:
   ```bash
   wp post delete $POST_ID --force
   echo "Test complete - fund deleted, campaign preserved in sandbox"
   ```

Document all results for summary.
  </action>
  <verify>
Full lifecycle works:
- Create: Campaign created with correct name, status "active", goal synced
- Update: Campaign name and goal updated
- Trash: Campaign status becomes "deactivated"
- Restore: Campaign status returns to "active"
  </verify>
  <done>
E2E test confirms all Phase 2 requirements:
- CAMP-01: Create via template duplication (working)
- CAMP-02: Update name/goal (working)
- CAMP-03: Trash deactivates (working)
- CAMP-04: Restore reactivates and publishes (working)
- CAMP-05: Campaign ID stored (working)
- CAMP-06: Campaign URL stored (working)
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Add "Disable Campaign Sync" ACF checkbox field</action>
  <instructions>
The code checks for `disable_campaign_sync` in the `gofundme_settings` ACF field group.

**Steps to add the field:**

1. Log into WordPress admin on staging: https://frederickc2stg.wpengine.com/wp-admin/
2. Navigate to: ACF > Field Groups
3. Find and edit the "GoFundMe Settings" field group
4. Click "Add Field"
5. Configure the field:
   - **Field Label:** Disable Campaign Sync
   - **Field Name:** disable_campaign_sync (should auto-generate)
   - **Field Type:** True / False
   - **Instructions:** Check to prevent this fund from creating or updating a campaign in GoFundMe Pro. Designation sync will still work.
   - **Default Value:** No (unchecked)
   - **Stylized UI:** Off (use standard checkbox)
6. Position the field appropriately (after fundraising_goal if it exists)
7. Click "Update" to save the field group

**Verification:**
- Edit any fund in WordPress
- Confirm "Disable Campaign Sync" checkbox appears in the GoFundMe Settings section
- The field should be unchecked by default
  </instructions>
  <resume-signal>Type "field added" when the ACF checkbox is configured and visible on fund edit screens</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Test sync opt-out functionality</name>
  <files></files>
  <action>
After ACF field is configured, test the opt-out mechanism.

1. SSH to staging:
   ```bash
   ssh frederickc2stg@frederickc2stg.ssh.wpengine.net
   cd ~/sites/frederickc2stg
   ```

2. Create a fund with sync disabled:
   ```bash
   # Create draft fund first
   POST_ID=$(wp post create --post_type=funds \
     --post_title="Opt-Out Test Fund $(date +%s)" \
     --post_content="Testing disable campaign sync." \
     --post_status=draft \
     --porcelain)
   echo "Created fund: $POST_ID"

   # Set the disable flag via ACF
   wp eval "update_field('gofundme_settings_disable_campaign_sync', true, $POST_ID);"

   # Publish the fund
   wp post update $POST_ID --post_status=publish
   ```

3. Verify NO campaign was created:
   ```bash
   CAMPAIGN_ID=$(wp post meta get $POST_ID _gofundme_campaign_id)
   if [ -z "$CAMPAIGN_ID" ]; then
     echo "SUCCESS: No campaign created (opt-out working)"
   else
     echo "FAILURE: Campaign $CAMPAIGN_ID was created despite opt-out"
   fi

   # But designation should still exist
   DESIGNATION_ID=$(wp post meta get $POST_ID _gofundme_designation_id)
   echo "Designation ID: $DESIGNATION_ID (should exist)"
   ```

4. Clean up:
   ```bash
   wp post delete $POST_ID --force
   ```
  </action>
  <verify>
Fund with disable_campaign_sync=true:
- Does NOT create campaign (no _gofundme_campaign_id)
- Still creates designation (designation sync unaffected)
  </verify>
  <done>
Sync opt-out verified:
- Funds with disable_campaign_sync checked do not create campaigns
- Designation sync continues to work normally
- Opt-out mechanism is functional
  </done>
</task>

</tasks>

<verification>
1. Full lifecycle test passes on staging
2. ACF "Disable Campaign Sync" field configured and visible
3. Opt-out mechanism prevents campaign creation while allowing designation sync
4. All six CAMP requirements verified working
</verification>

<success_criteria>
- All Phase 2 requirements (CAMP-01 through CAMP-06) verified working
- ACF checkbox configured for campaign sync opt-out
- Opt-out tested and functional
- Phase 2 ready for production deployment
</success_criteria>

<output>
After completion, create `.planning/phases/02-campaign-push-sync/02-04-SUMMARY.md`
</output>
