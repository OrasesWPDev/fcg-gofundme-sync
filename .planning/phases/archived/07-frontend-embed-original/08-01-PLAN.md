# Plan 07-01: Frontend Embed Integration

## Goal

Replace the legacy donation form on fund pages with Classy embedded donation forms, using ACF fields to store campaign configuration per fund.

## Prerequisites

- [x] Classy WP plugin installed and configured with Org ID (105659)
- [x] Staging domain safelisted in Classy (frederickc2stg.wpenginepowered.com)
- [x] Test campaign created and verified working (764041)
- [ ] At least one fund has Embedded Form Campaign created in Classy

## Dependencies

- **Classy:** Each fund needs an Embedded Form Campaign created manually in Classy UI
- **ACF:** Fields must be added to store Campaign ID and Component ID per fund

## Implementation Steps

### Step 1: Create ACF Fields for Embed Configuration

Add new fields to the funds post type for storing Classy embed data.

**Field Group:** GoFundMe Embed Settings (or add to existing GoFundMe Settings group)

| Field Name | Field Type | Instructions |
|------------|------------|--------------|
| `classy_campaign_id` | Text | Campaign ID from Classy (e.g., 764041). Found in Settings → Install. |
| `classy_component_id` | Text | Component ID from Classy embed code (e.g., S9nYPwV-n0eBvabmj6qJk). Found in Settings → Install → Inline donation grid. |

**Location:** Show if Post Type == funds

**Options:**
- Both fields should be in a collapsible group labeled "Classy Donation Form"
- Add help text explaining where to find these values in Classy

### Step 2: Update fund-form.php Template

Replace the legacy donation form with dynamic Classy embed.

**File:** `wp-content/themes/community-foundation/fund-form.php`

**Current (legacy):**
```php
<h4>Make a Donation</h4>

<form class="donate-form">
  <input type="hidden" class="js-product-name" value="<?php esc_attr(the_title()) ?>">
  <div class="input-group mr-lg-3">
    <div class="input-group-prepend text-secondary">$</div>
    <input type="text" class="js-product-amount form-control" placeholder="0.00">
  </div>
  <button class="js-add-to-cart btn btn-primary" disabled>Review Your Donation</button>
</form>

<h6 class="js-cart-title mt-4 mb-2" style="display: none;">Saved Donations</h6>

<?php get_template_part('fund-cart') ?>
```

**New (with Classy embed):**
```php
<?php
$campaign_id = get_field('classy_campaign_id');
$component_id = get_field('classy_component_id');
?>

<h4>Make a Donation</h4>

<?php if ($campaign_id && $component_id): ?>
  <!-- Classy Embedded Donation Form -->
  <div id="<?php echo esc_attr($component_id); ?>" classy="<?php echo esc_attr($campaign_id); ?>"></div>
<?php else: ?>
  <!-- Fallback: Legacy form or message -->
  <div class="donate-form-fallback">
    <p class="text-muted">
      Online donations for this fund are coming soon.
      Please <a href="/contact/">contact us</a> to make a donation.
    </p>
  </div>
<?php endif; ?>
```

### Step 3: Handle Modal Context

The `fund-form.php` template is used in two contexts:
1. **Single fund page** (`single-funds.php`) - has access to current post
2. **Modal popup** (`fund-modal.php`) - rendered in a loop, needs post ID passed

**Verify modal context:** Check `fund-modal.php` to ensure `get_field()` works correctly within the modal loop. May need to pass post ID explicitly:

```php
$campaign_id = get_field('classy_campaign_id', get_the_ID());
```

### Step 4: Clean Up Legacy Assets (Optional)

Once Classy embeds are working site-wide:
- Remove or deprecate `fund-cart.php` template part
- Remove legacy JS for `js-add-to-cart` functionality
- Clean up related CSS

**Note:** Keep legacy code available during transition period. Some funds may not have Classy campaigns yet.

### Step 5: Admin Documentation

Create admin instructions for the client workflow:

**Creating a Classy Donation Form for a Fund:**

1. **In Classy Dashboard:**
   - Go to Campaigns → Create Campaign
   - Select: Direct giving → Embedded form
   - Choose the fund's designation from the dropdown
   - Configure form settings (amounts, frequencies)
   - Go to Settings → Install
   - Add your website domain to Safelisted domains
   - Click Publish

2. **Copy the IDs:**
   - Campaign ID: Found at top of Install page or in URL
   - Component ID: Click "Copy inline embed code" and extract the `id` value

3. **In WordPress:**
   - Edit the fund post
   - Scroll to "Classy Donation Form" section
   - Paste Campaign ID and Component ID
   - Update the fund

## Verification Checklist

- [ ] ACF fields appear on fund edit screen
- [ ] Fund with both IDs filled shows Classy embed on fund page
- [ ] Fund with both IDs filled shows Classy embed in modal popup
- [ ] Fund with missing IDs shows fallback message
- [ ] Clicking "Donate" on embed opens Classy payment flow
- [ ] Donation completes successfully in sandbox
- [ ] Donation appears in Classy dashboard under correct campaign/designation

## Rollback Plan

If issues arise:
1. Restore original `fund-form.php` from git
2. ACF fields can remain (unused fields don't affect frontend)
3. Classy WP plugin can be deactivated if SDK causes issues

## Files Changed

| File | Type | Description |
|------|------|-------------|
| `fund-form.php` | Theme template | Replace legacy form with dynamic Classy embed |
| ACF Field Group | WordPress config | Add classy_campaign_id and classy_component_id fields |

## Manual Steps Required

1. **Create ACF fields** via WordPress Admin → ACF → Field Groups
2. **Test with Ada B. Poole fund** - enter the test campaign IDs
3. **Verify both page and modal** work correctly

## Notes

- The Classy WP plugin must remain active for the SDK to load
- Organization ID (105659) must be set in plugin settings
- Each fund's domain must be safelisted in Classy before embeds will work
- Production domain will need to be safelisted before go-live
