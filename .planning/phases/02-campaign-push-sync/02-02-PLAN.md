---
phase: 02-campaign-push-sync
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - includes/class-sync-handler.php
autonomous: true

must_haves:
  truths:
    - "When fund is published, campaign is created via template duplication"
    - "Newly created campaign is published (made active) immediately after duplication"
    - "Campaign ID is stored in fund post meta"
    - "Campaign URL is stored in fund post meta"
    - "Race condition prevented via transient lock during creation"
  artifacts:
    - path: "includes/class-sync-handler.php"
      provides: "Campaign creation via duplication workflow"
      contains: "duplicate_campaign"
  key_links:
    - from: "create_campaign_in_gfm()"
      to: "FCG_GFM_API_Client::duplicate_campaign()"
      via: "$this->api->duplicate_campaign()"
      pattern: "duplicate_campaign.*template"
    - from: "create_campaign_in_gfm()"
      to: "FCG_GFM_API_Client::publish_campaign()"
      via: "$this->api->publish_campaign()"
      pattern: "publish_campaign"
---

<objective>
Rewrite campaign creation to use template duplication workflow.

Purpose: The current `create_campaign_in_gfm()` uses POST /campaigns which returns 403. Must use duplicate-then-publish workflow with the template campaign configured in Phase 1.

Output: Updated sync handler that creates campaigns via template duplication and publishes them immediately.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-campaign-push-sync/02-RESEARCH.md
@.planning/phases/02-campaign-push-sync/02-01-SUMMARY.md
@includes/class-sync-handler.php
@includes/class-api-client.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite create_campaign_in_gfm() to use duplication workflow</name>
  <files>includes/class-sync-handler.php</files>
  <action>
Replace the existing `create_campaign_in_gfm()` method (around line 392) with a new implementation that:

1. **Check prerequisites:**
   - Get template campaign ID from `get_option('fcg_gfm_template_campaign_id')`
   - If no template ID configured, log error and return early
   - Check for race condition lock: `get_transient("fcg_gfm_creating_campaign_{$post_id}")`
   - If lock exists, return early (creation already in progress)
   - Set transient lock for 60 seconds before making API calls

2. **Duplicate template campaign:**
   - Build overrides array from the $data parameter:
     - `name` => $data['name']
     - `raw_goal` => (string) $data['goal'] (Classy expects string for raw_goal)
     - `raw_currency_code` => 'USD'
     - `started_at` => date('c', strtotime($data['started_at'])) (ISO 8601 format)
     - `external_reference_id` => $data['external_reference_id']
   - Call `$this->api->duplicate_campaign($template_id, $overrides)`
   - On failure: log error, delete transient lock, return

3. **Update overview (if present):**
   - If $data['overview'] is not empty, call:
     `$this->api->update_campaign($campaign_id, ['overview' => $data['overview']])`
   - Log warning on failure but continue (non-fatal)

4. **Publish campaign:**
   - Call `$this->api->publish_campaign($campaign_id)`
   - Log warning on failure but continue (campaign can be published manually)

5. **Store campaign data in post meta:**
   - `update_post_meta($post_id, self::META_CAMPAIGN_ID, $campaign_id)`
   - `update_post_meta($post_id, self::META_CAMPAIGN_URL, $campaign_url)`
   - `update_post_meta($post_id, self::META_KEY_LAST_SYNC, current_time('mysql'))`

6. **Cleanup:**
   - Delete the transient lock
   - Log success message

The method signature stays the same: `private function create_campaign_in_gfm(int $post_id, array $data): void`
  </action>
  <verify>
`php -l includes/class-sync-handler.php` returns no errors
`grep -c "duplicate_campaign" includes/class-sync-handler.php` returns at least 1
`grep -c "publish_campaign" includes/class-sync-handler.php` returns at least 1
`grep -c "fcg_gfm_template_campaign_id" includes/class-sync-handler.php` returns at least 1
  </verify>
  <done>
create_campaign_in_gfm() rewritten to:
- Get template ID from plugin settings
- Duplicate template with overrides (name, goal, started_at, external_reference_id)
- Update overview separately (not available in duplication overrides)
- Publish campaign to make it active
- Store campaign ID and URL in post meta
- Use transient lock to prevent race conditions
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy and test campaign creation on staging</name>
  <files>includes/class-sync-handler.php</files>
  <action>
1. Deploy updated plugin to staging:
   ```bash
   rsync -avz --exclude='.git' --exclude='.planning' \
     /Users/chadmacbook/projects/fcg/ \
     frederickc2stg@frederickc2stg.ssh.wpengine.net:~/sites/frederickc2stg/wp-content/plugins/fcg-gofundme-sync/
   ```

2. SSH to staging and create a test fund:
   ```bash
   ssh frederickc2stg@frederickc2stg.ssh.wpengine.net
   cd ~/sites/frederickc2stg

   # Create a test fund and publish it
   wp post create --post_type=funds \
     --post_title="Test Fund $(date +%s)" \
     --post_content="This is a test fund for campaign sync verification." \
     --post_status=publish \
     --porcelain
   ```

3. Check that campaign was created:
   ```bash
   # Get the post ID from previous command, then:
   POST_ID=<id from previous command>

   wp post meta get $POST_ID _gofundme_campaign_id
   wp post meta get $POST_ID _gofundme_campaign_url
   wp post meta get $POST_ID _gofundme_last_sync
   ```

4. Verify campaign exists in Classy:
   ```bash
   wp eval "
   \$api = new FCG_GFM_API_Client();
   \$campaign_id = get_post_meta($POST_ID, '_gofundme_campaign_id', true);
   if (\$campaign_id) {
     \$result = \$api->get_campaign(\$campaign_id);
     if (\$result['success']) {
       echo 'Campaign exists: ' . \$result['data']['name'] . '\n';
       echo 'Status: ' . \$result['data']['status'] . '\n';
       echo 'URL: ' . (\$result['data']['canonical_url'] ?? 'N/A') . '\n';
     } else {
       echo 'Failed to fetch: ' . \$result['error'] . '\n';
     }
   } else {
     echo 'No campaign ID in meta\n';
   }
   "
   ```

5. Clean up test fund (but leave campaign - it's in sandbox):
   ```bash
   wp post delete $POST_ID --force
   ```

Expected results:
- Campaign ID stored in `_gofundme_campaign_id`
- Campaign URL stored in `_gofundme_campaign_url`
- Campaign status is "active" (not "unpublished")
- Campaign name matches fund title
  </action>
  <verify>
- `wp post meta get $POST_ID _gofundme_campaign_id` returns a numeric campaign ID
- `wp post meta get $POST_ID _gofundme_campaign_url` returns a Classy URL
- Campaign status in Classy is "active"
  </verify>
  <done>
Campaign creation workflow verified on staging:
- Publishing a fund creates a campaign via template duplication
- Campaign is automatically published (status: active)
- Campaign ID and URL stored in post meta
- Last sync timestamp updated
  </done>
</task>

</tasks>

<verification>
1. `php -l includes/class-sync-handler.php` passes
2. Code contains duplicate_campaign and publish_campaign calls
3. Template ID is read from plugin settings
4. Staging test: new published fund creates campaign in Classy
5. Campaign ID and URL stored in post meta
6. Campaign status is "active" (publish step worked)
</verification>

<success_criteria>
- create_campaign_in_gfm() uses duplicate-then-publish workflow
- Template campaign ID sourced from plugin settings
- Race condition protection via transient lock
- Publishing a fund on staging creates active campaign in Classy sandbox
- Campaign ID and URL stored in fund post meta
</success_criteria>

<output>
After completion, create `.planning/phases/02-campaign-push-sync/02-02-SUMMARY.md`
</output>
