---
phase: 03-campaign-status-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-sync-handler.php
  - fcg-gofundme-sync.php
  - CLAUDE.md
autonomous: false

must_haves:
  truths:
    - "When fund is set to draft, campaign status is unpublished (not deactivated)"
    - "When fund is republished from draft, campaign returns to active status"
    - "When fund is trashed, campaign is deactivated (existing behavior preserved)"
    - "When fund is restored from trash, campaign is reactivated then published (existing behavior preserved)"
  artifacts:
    - path: "includes/class-sync-handler.php"
      provides: "Corrected status change logic calling unpublish_campaign for draft"
      contains: "unpublish_campaign"
  key_links:
    - from: "includes/class-sync-handler.php"
      to: "includes/class-api-client.php"
      via: "unpublish_campaign() method call"
      pattern: "\\$this->api->unpublish_campaign"
---

<objective>
Fix the bug where setting a fund to draft incorrectly deactivates the campaign instead of unpublishing it.

Purpose: Correct campaign status mapping so draft funds have unpublished (not deactivated) campaigns, enabling simpler republish workflow.

Output: Updated sync handler calling unpublish_campaign() for draft status, verified via E2E testing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-campaign-status-management/03-RESEARCH.md
@includes/class-sync-handler.php
@includes/class-api-client.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix on_status_change() to call unpublish_campaign() for draft status</name>
  <files>includes/class-sync-handler.php, fcg-gofundme-sync.php</files>
  <action>
Modify the `on_status_change()` method in `class-sync-handler.php` to handle draft status separately from trash.

**CRITICAL: REPLACE the else clause entirely - do NOT keep it.**

**Current buggy code structure (lines ~310-321):**
```php
if ($is_active) {
    // publish logic
} else {  // â† THIS ENTIRE ELSE BLOCK MUST BE REMOVED
    $campaign_result = $this->api->deactivate_campaign($campaign_id);
    if ($campaign_result['success']) {
        $this->log_info("Status change: deactivated campaign {$campaign_id} for post {$post->ID}");
    }
}
```

**REPLACE WITH (only handle draft - no other statuses needed):**
```php
if ($is_active) {
    // existing publish logic (keep as-is)
} elseif ($new_status === 'draft') {
    // STAT-01: Unpublish campaign when fund is set to draft
    // Note: Unpublish is reversible with a single publish call
    // Deactivate (used for trash) requires reactivate+publish
    $campaign_result = $this->api->unpublish_campaign($campaign_id);
    if ($campaign_result['success']) {
        $this->log_info("Status change: unpublished campaign {$campaign_id} for post {$post->ID}");
    } else {
        $this->log_error("Failed to unpublish campaign {$campaign_id}: " . ($campaign_result['error'] ?? 'Unknown error'));
    }
}
// NO else clause here - trash is handled by on_trash_fund(), delete by on_delete_fund()
// Keeping an else would cause double deactivation (on_status_change + on_trash_fund)
```

**Why only draft status:**
- User confirmed funds only use publish/draft/trash statuses
- pending/private/future are not used and should not be handled
- Requirements STAT-01/02/03 only specify draft, publish, trash

**Why the else must go completely:**
- `on_trash_fund()` already handles trash status with deactivate_campaign()
- `on_delete_fund()` already handles permanent deletion
- Keeping the else causes duplicate API calls (on_status_change fires before trash hook)

**Version bump:** Update version in `fcg-gofundme-sync.php` plugin header from 2.1.3 to 2.1.4.

**Why NOT deactivate for draft:**
- Deactivated campaigns require reactivate -> publish (2 API calls) to restore
- Unpublished campaigns require only publish (1 API call) to restore
- Draft is temporary; trash is more permanent - status handling should reflect this
  </action>
  <verify>
    - `grep -n "unpublish_campaign" includes/class-sync-handler.php` shows the new call
    - `grep -n "=== 'draft'" includes/class-sync-handler.php` shows draft-specific handling
    - `grep -c "} else {" includes/class-sync-handler.php` in on_status_change should NOT include catch-all deactivate
    - `grep "Version:" fcg-gofundme-sync.php` shows 2.1.4
  </verify>
  <done>
    - on_status_change() calls unpublish_campaign() when post status is draft
    - on_status_change() else clause removed entirely (no catch-all deactivate)
    - Trash/delete handled ONLY by their dedicated hooks (on_trash_fund, on_delete_fund)
    - Plugin version bumped to 2.1.4
  </done>
</task>

<task type="auto">
  <name>Task 1b: Document deployment method in CLAUDE.md</name>
  <files>CLAUDE.md</files>
  <action>
Update CLAUDE.md to add a "Deployment" section after the "Staging Environment" section.

**Add the following section:**

```markdown
## Deployment

**WP Engine Constraints:**
- **SCP is NOT supported** - WP Engine blocks SCP connections
- **rsync IS supported** - Use rsync for all deployments
- **SFTP available** - As fallback via FileZilla/Transmit or WP Engine File Manager

**Deploy to Staging (rsync):**
```bash
rsync -avz --exclude='.git' --exclude='.planning' --exclude='*.zip' \
  /Users/chadmacbook/projects/fcg/ \
  frederickc2stg@frederickc2stg.ssh.wpengine.net:~/sites/frederickc2stg/wp-content/plugins/fcg-gofundme-sync/
```

**Deploy to Production (rsync):**
```bash
rsync -avz --exclude='.git' --exclude='.planning' --exclude='*.zip' \
  /Users/chadmacbook/projects/fcg/ \
  frederickcount@frederickcount.ssh.wpengine.net:~/sites/frederickcount/wp-content/plugins/fcg-gofundme-sync/
```

**Post-Deployment Cleanup:**
Always remove any zip files from the project directory after deployment:
```bash
rm -f /Users/chadmacbook/projects/fcg/*.zip
```
```

This documents the correct deployment method for future reference and ensures the team knows SCP does not work with WP Engine.
  </action>
  <verify>
    - `grep -A 5 "## Deployment" CLAUDE.md` shows the new section
    - `grep "rsync" CLAUDE.md` shows rsync commands for staging and production
    - `grep "SCP is NOT supported" CLAUDE.md` confirms constraint is documented
    - `grep "rm -f.*\.zip" CLAUDE.md` confirms cleanup step is documented
  </verify>
  <done>
    - CLAUDE.md contains Deployment section with WP Engine constraints
    - rsync commands documented for both staging and production
    - Cleanup step documented (remove zip files)
    - SCP limitation clearly stated
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy to staging and run E2E status tests</name>
  <files>N/A (deployment only)</files>
  <action>
Deploy the updated plugin to WP Engine staging using rsync and test the complete status lifecycle:

**Deploy via rsync:**

```bash
rsync -avz --exclude='.git' --exclude='.planning' --exclude='*.zip' \
  /Users/chadmacbook/projects/fcg/ \
  frederickc2stg@frederickc2stg.ssh.wpengine.net:~/sites/frederickc2stg/wp-content/plugins/fcg-gofundme-sync/
```

**Test sequence using existing test fund (post 13771, campaign 763426):**

1. **STAT-01 Test (publish -> draft -> unpublished):**
   - Set fund 13771 to Draft status in WordPress
   - Verify campaign 763426 status via Classy API: `GET /campaigns/763426`
   - Expected: status = "unpublished"
   - Check log shows "unpublished campaign" (NOT "deactivated")

2. **STAT-02 Test (draft -> publish -> active):**
   - Set fund 13771 back to Published
   - Verify campaign status via API
   - Expected: status = "active"

3. **STAT-03 Full cycle verification:**
   - Publish (active)
   - Draft (unpublished)
   - Publish (active)

4. **Trash/Restore regression test (verify fix doesn't break existing hooks):**
   - Trash fund 13771
   - Verify campaign 763426 status = "deactivated" (via on_trash_fund)
   - Check logs show ONLY ONE "deactivated" call (not double from on_status_change + on_trash_fund)
   - Restore fund 13771 from trash
   - Verify campaign 763426 status = "active" (via on_untrash_fund reactivate+publish)
   - Check logs show reactivate -> publish sequence

**API verification commands (run on staging):**
```bash
# Check campaign status
wp eval "
\$api = new FCG_GFM_API_Client();
\$result = \$api->get_campaign(763426);
echo 'Campaign status: ' . \$result['data']['status'];
"
```

**Check error log for sync messages:**
```bash
tail -f ~/logs/php-error.log | grep 'FCG GoFundMe Sync'
```

**Key verification for Blocker fix:**
When trashing fund, grep logs for "deactivated" - should appear exactly ONCE (from on_trash_fund only).

**Cleanup (always run after deployment):**
```bash
# Clean up any zip files in project directory
rm -f /Users/chadmacbook/projects/fcg/*.zip
```
  </action>
  <verify>
    - Campaign 763426 status changes to "unpublished" when fund set to draft
    - Campaign 763426 status changes to "active" when fund republished
    - Error log shows "unpublished campaign" message (not "deactivated") for draft
    - Trash shows exactly ONE "deactivated" call in logs (on_trash_fund only)
    - Restore shows reactivate+publish sequence, campaign returns to "active"
    - No .zip files remain in project directory
  </verify>
  <done>
    - STAT-01 verified: draft -> unpublished
    - STAT-02 verified: republish -> active
    - STAT-03 verified: full status mapping correct
    - Trash regression verified: single deactivate call (no double-fire)
    - Restore regression verified: reactivate+publish flow works
    - Project directory cleaned (no zip files)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify status mapping in Classy dashboard</name>
  <what-built>
Campaign status management bug fix:
- Draft funds now unpublish campaigns (instead of deactivate)
- Republishing from draft restores active status with single publish call
- Trash/restore workflow unchanged (still uses deactivate/reactivate+publish)
- Removed catch-all else clause to prevent double deactivation on trash
  </what-built>
  <how-to-verify>
1. Log into Classy sandbox dashboard
2. Find campaign 763426 (Updated_E2E_Fresh_Test or similar)
3. Verify current status shows "Active" (green)
4. In WordPress staging, set fund 13771 to Draft
5. Refresh Classy dashboard - campaign should show "Unpublished" (not "Deactivated")
6. In WordPress, republish fund 13771
7. Refresh Classy - campaign should show "Active" again
8. Test trash/restore cycle:
   - Trash fund 13771
   - Refresh Classy - campaign should show "Deactivated"
   - Restore fund 13771 from trash
   - Refresh Classy - campaign should show "Active"
  </how-to-verify>
  <resume-signal>Type "approved" if status mapping is correct, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
- [ ] `unpublish_campaign()` is called from on_status_change() for draft status only
- [ ] `deactivate_campaign()` is NOT called from on_status_change() (only from on_trash_fund)
- [ ] Else clause completely removed from on_status_change() status handling
- [ ] Campaign status transitions: active <-> unpublished (via draft) <-> deactivated (via trash)
- [ ] Error logging shows correct action ("unpublished" for draft, "deactivated" for trash)
- [ ] Trash operation produces exactly one deactivate call (no double-fire)
- [ ] Plugin version updated to 2.1.4
- [ ] CLAUDE.md contains Deployment section with rsync commands
- [ ] No zip files remain in project directory after deployment
</verification>

<success_criteria>
1. When fund 13771 is set to draft, campaign 763426 status = "unpublished"
2. When fund 13771 is republished, campaign 763426 status = "active"
3. When fund 13771 is trashed, campaign 763426 status = "deactivated" (single API call, no double-fire)
4. When fund 13771 is restored from trash, campaign 763426 status = "active" (reactivate+publish flow)
5. All three requirements (STAT-01, STAT-02, STAT-03) verified working
6. No regression in trash/restore behavior
7. Deployment documentation added to CLAUDE.md
8. Project directory clean (no leftover zip files)
</success_criteria>

<output>
After completion, create `.planning/phases/03-campaign-status-management/03-01-SUMMARY.md`
</output>
