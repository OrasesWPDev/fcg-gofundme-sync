# Codebase Structure

**Analysis Date:** 2026-01-22

## Directory Layout

```
fcg-gofundme-sync/
├── fcg-gofundme-sync.php          # Main plugin file, initialization, admin notices
├── uninstall.php                  # Plugin cleanup on deletion
├── includes/
│   ├── class-api-client.php       # OAuth2 + GoFundMe Pro API wrapper
│   ├── class-sync-handler.php     # WordPress hooks + outbound sync
│   ├── class-sync-poller.php      # WP-Cron polling + inbound sync + WP-CLI
│   └── class-admin-ui.php         # Admin interface + dashboard
├── assets/
│   ├── css/
│   │   └── admin.css              # Admin styles
│   └── js/
│       └── admin.js               # Admin JavaScript
├── readme.txt                     # Plugin readme
├── CLAUDE.md                      # Project guidance (local development notes)
└── .planning/                     # GSD planning documents
    └── codebase/                  # Architecture analysis output
```

## Directory Purposes

**Root Directory:**
- Purpose: Plugin definition, entry point, and cleanup
- Contains: Main plugin file (header + initialization), uninstall routine, readme
- Key files: `fcg-gofundme-sync.php` (core initialization), `uninstall.php` (cleanup on deletion)

**`includes/`:**
- Purpose: Core plugin classes and business logic
- Contains: Four PHP classes handling API communication, outbound sync, inbound sync/polling, admin UI
- Naming pattern: `class-{component}.php`
- All classes prefixed with `FCG_GFM_` namespace

**`assets/css/`:**
- Purpose: Styling for WordPress admin interface
- Contains: Single CSS file for sync status column, meta boxes, and settings page
- Loaded: Only in WordPress admin for 'funds' post type

**`assets/js/`:**
- Purpose: JavaScript for admin interactivity
- Contains: AJAX handlers for manual sync buttons, progress indication
- Loaded: Only in WordPress admin for 'funds' post type
- Dependencies: jQuery (enqueued by WordPress)

## Key File Locations

**Entry Points:**

- `fcg-gofundme-sync.php`: Plugin activation point
  - Executed by WordPress on every page load after all plugins loaded
  - Defines plugin header (name, version, author, etc.)
  - Contains `fcg_gfm_sync_init()` hooked to `plugins_loaded`
  - Responsible for credential checking and class instantiation
  - Registers activation/deactivation hooks for WP-Cron management

**Configuration:**

- `fcg-gofundme-sync.php`: Credential validation
  - Reads from: Environment variables (recommended) or PHP constants
  - Checks: `GOFUNDME_CLIENT_ID`, `GOFUNDME_CLIENT_SECRET`, `GOFUNDME_ORG_ID`
  - Fails gracefully: Shows admin notices if credentials missing
  - No credentials stored in codebase

**Core Logic:**

- `includes/class-api-client.php`: External API communication
  - Handles OAuth2 token acquisition and caching
  - Wraps HTTP requests to GoFundMe Pro API
  - Provides methods for designation CRUD and campaign operations
  - All API communication goes through `request()` method
  - Standardized response format: `['success' => bool, 'data' => mixed, 'error' => string]`

- `includes/class-sync-handler.php`: Outbound synchronization
  - Hooks into WordPress post lifecycle events
  - Builds designation and campaign data from post
  - Creates, updates, or deactivates designations based on post status
  - Prevents recursion during inbound sync
  - Integrates with ACF if available for additional fields

- `includes/class-sync-poller.php`: Inbound synchronization
  - WP-Cron polling triggered every 15 minutes
  - Fetches all designations from GoFundMe Pro
  - Detects changes via hash comparison
  - Resolves conflicts (WordPress always wins)
  - Retries failed syncs with exponential backoff
  - Provides WP-CLI commands for manual operations

- `includes/class-admin-ui.php`: WordPress admin interface
  - Renders sync status column in funds list table
  - Adds meta box to fund edit screen
  - Creates settings page under funds menu
  - Shows admin notices for sync errors
  - Handles AJAX requests for manual sync trigger

**Testing & Documentation:**

- `.planning/codebase/`: GSD planning documents
  - Generated by `/gsd:map-codebase` command
  - Contains: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md
  - Used by: `/gsd:plan-phase` and `/gsd:execute-phase` commands
  - NOT committed to git (gitignored)

## Naming Conventions

**Files:**
- Pattern: `class-{component-name}.php`
- Examples: `class-api-client.php`, `class-sync-handler.php`, `class-sync-poller.php`, `class-admin-ui.php`
- Main file: `{plugin-slug}.php` (e.g., `fcg-gofundme-sync.php`)
- Cleanup: `uninstall.php` (WordPress standard)

**Classes:**
- Pattern: `FCG_GFM_{Component}`
- Prefix: `FCG_` (Frederick County Gives) + `GFM_` (GoFundMe)
- Examples:
  - `FCG_GFM_API_Client`
  - `FCG_GFM_Sync_Handler`
  - `FCG_GFM_Sync_Poller`
  - `FCG_GFM_Admin_UI`

**Functions (Plugin initialization):**
- Pattern: `fcg_gfm_{action}`
- Examples:
  - `fcg_gfm_sync_init()`
  - `fcg_gfm_has_credential()`
  - `fcg_gfm_sync_activate()`
  - `fcg_gfm_sync_deactivate()`

**Hooks & Actions:**
- Pattern: `fcg_gofundme_sync_poll`, `fcg_gfm_15min`, `fcg_gfm_syncing_inbound`
- WP-CLI: `fcg-sync {subcommand}`
- AJAX: `fcg_gfm_sync_now`, `fcg_gfm_sync_nonce`

**Post Meta Keys:**
- Pattern: `_gofundme_{property}`
- Underscore prefix: Indicates "private" meta (hidden from UI)
- Examples:
  - `_gofundme_designation_id`
  - `_gofundme_campaign_id`
  - `_gofundme_campaign_url`
  - `_gofundme_last_sync`
  - `_gofundme_poll_hash`
  - `_gofundme_sync_source`
  - `_gofundme_sync_error`
  - `_gofundme_sync_attempts`
  - `_gofundme_sync_last_attempt`

**Options (Plugin-wide state):**
- Pattern: `fcg_gfm_{setting}`
- Examples:
  - `fcg_gfm_last_poll`
  - `fcg_gfm_poll_enabled`
  - `fcg_gfm_poll_interval`
  - `fcg_gfm_conflict_log`

**CSS/JS Classes:**
- Pattern: `fcg-sync-{element}`
- Examples: `.fcg-sync-status`, `.fcg-sync-error`, `.fcg-sync-meta-box`, `.fcg-sync-now-btn`

## Where to Add New Code

**New Sync Feature (designations/campaigns):**
- Add method to `includes/class-api-client.php` for API endpoint
- Add handler method to `includes/class-sync-handler.php` for outbound logic
- Add processing to `includes/class-sync-poller.php` if needs inbound polling
- Update `includes/class-admin-ui.php` if needs admin visibility
- Update post meta keys in this document
- Update CLAUDE.md with any new behavior

**New Admin UI Element:**
- Add to `includes/class-admin-ui.php`
- Register appropriate WordPress hook (filter for columns, action for metaboxes, etc.)
- Add styling to `assets/css/admin.css`
- Add JavaScript behavior to `assets/js/admin.js` if needed
- Enqueue in `enqueue_scripts()` method

**New WP-CLI Command:**
- Add method to `includes/class-sync-poller.php` class
- Register with `\WP_CLI::add_command()` in constructor
- Follow existing method pattern: public, receives `$args` and `$assoc_args`
- Output via `\WP_CLI::log()`, `\WP_CLI::success()`, `\WP_CLI::warning()`, `\WP_CLI::error()`

**New Utility Function:**
- For helper functions: Add to relevant class as private method
- For reusable functions: Add to main plugin file or create utility class
- Naming: Follow `fcg_gfm_{action}()` pattern
- Document with PHPDoc block

**New Post Meta Key:**
- Define in relevant class as class constant
- Naming: `_gofundme_{property}`
- Update `uninstall.php` cleanup comments if applicable
- Update this document under "Naming Conventions"

**Debugging/Testing:**
- Test files go in: NOT YET CREATED (no `/tests` directory currently)
- Future approach: Create `tests/` directory with pattern matching file structure
- Test file naming: `test-{component}.php`

## Special Directories

**`.planning/codebase/`:**
- Purpose: Store GSD-generated codebase analysis documents
- Generated: By `/gsd:map-codebase` command
- Committed: NO (in .gitignore)
- Contents: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md
- Lifecycle: Regenerated when codebase mapping is run
- Used by: `/gsd:plan-phase` and `/gsd:execute-phase` for context

**`.idea/`:**
- Purpose: JetBrains IDE project configuration
- Generated: Automatically by IDE
- Committed: NO (in .gitignore)
- Notes: Local development environment config only

**`.git/`:**
- Purpose: Git version control
- Committed: YES (internal git metadata)
- Notes: All plugin code tracked; secrets excluded via .gitignore

## Integration Points with WordPress

**Hooks Used (Action):**
- `plugins_loaded` - Plugin initialization
- `register_activation_hook` - WP-Cron schedule setup
- `register_deactivation_hook` - WP-Cron cleanup
- `save_post_{post_type}` - Handle fund post saves
- `wp_trash_post` - Handle fund trashing
- `untrash_post` - Handle fund restoration
- `before_delete_post` - Handle fund deletion
- `transition_post_status` - Handle publish/draft changes
- `fcg_gofundme_sync_poll` - WP-Cron polling callback
- `add_meta_boxes` - Admin meta box registration
- `add_admin_menu` - Settings page registration
- `admin_init` - Settings initialization
- `admin_notices` - Error notices
- `manage_{post_type}_posts_columns` - List table column
- `manage_{post_type}_posts_custom_column` - List table rendering
- `admin_enqueue_scripts` - Script/style loading
- `wp_ajax_{action}` - AJAX handler
- `cron_schedules` - Custom cron interval

**Custom Hooks:**
- `fcg_gofundme_sync_poll` - Polled every 15 minutes by WP-Cron

---

*Structure analysis: 2026-01-22*
