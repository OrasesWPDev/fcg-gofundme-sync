---
phase: 06-master-campaign-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-admin-ui.php
  - includes/class-sync-handler.php
autonomous: true

must_haves:
  truths:
    - "Admin can configure master campaign ID in settings"
    - "Admin can configure master component ID in settings"
    - "When a fund is published, designation is linked to master campaign via API"
    - "Existing designation sync still works (create, update, deactivate)"
  artifacts:
    - path: "includes/class-admin-ui.php"
      provides: "Settings page with Master Campaign ID and Master Component ID fields"
      contains: "fcg_gofundme_master_campaign_id"
    - path: "includes/class-sync-handler.php"
      provides: "Post-creation hook that links designation to master campaign"
      contains: "link_designation_to_campaign"
  key_links:
    - from: "includes/class-sync-handler.php"
      to: "includes/class-api-client.php"
      via: "update_campaign() call after designation creation"
      pattern: "update_campaign.*designation_id"
    - from: "includes/class-admin-ui.php"
      to: "WordPress Options API"
      via: "register_setting for master_campaign_id and master_component_id"
      pattern: "register_setting.*fcg_gofundme_master"
---

<objective>
Implement master campaign settings and designation linking

Purpose: Enable automatic linking of new designations to the master campaign's active designation group
Output: Settings page with master campaign/component IDs, sync handler that links designations after creation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-master-campaign-integration/06-RESEARCH.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update settings page - rename template to master, add component ID</name>
  <files>includes/class-admin-ui.php</files>
  <action>
Update the FCG_GFM_Admin_UI class to rename the template campaign setting and add component ID:

**1. Update register_settings() method:**

Change the template campaign registration from:
```php
register_setting('fcg_gfm_sync', 'fcg_gfm_template_campaign_id', [
```
To:
```php
register_setting('fcg_gfm_sync', 'fcg_gofundme_master_campaign_id', [
```

Add new registration for component ID:
```php
register_setting('fcg_gfm_sync', 'fcg_gofundme_master_component_id', [
    'type' => 'string',
    'default' => '',
    'sanitize_callback' => 'sanitize_text_field',
]);
```

**2. Update validate_template_campaign_id() method:**

Rename method to `validate_master_campaign_id()`.

Update internal references from `fcg_gfm_template_*` to `fcg_gofundme_master_*`:
- `fcg_gfm_template_campaign_id` -> `fcg_gofundme_master_campaign_id`
- `fcg_gfm_template_campaign_name` -> `fcg_gofundme_master_campaign_name`
- `fcg_gfm_template_validation_failed` -> `fcg_gofundme_master_validation_failed`
- `fcg_gfm_template_validation_pending` -> `fcg_gofundme_master_validation_pending`

**3. Update render_settings_page() method:**

Update variable assignments at top:
```php
$master_id = get_option('fcg_gofundme_master_campaign_id', 0);
$master_name = get_option('fcg_gofundme_master_campaign_name', '');
$master_component_id = get_option('fcg_gofundme_master_component_id', '');
$validation_failed = get_option('fcg_gofundme_master_validation_failed', false);
$validation_pending = get_option('fcg_gofundme_master_validation_pending', false);
```

Update status display to use new variable names.

Update form fields:
- Rename "Template Campaign ID" label to "Master Campaign ID"
- Change input name from `fcg_gfm_template_campaign_id` to `fcg_gofundme_master_campaign_id`
- Add description: "The master campaign that contains all fund designations (e.g., 764694)"

Add new Master Component ID field after Master Campaign ID:
```php
<tr>
    <th scope="row">Master Component ID</th>
    <td>
        <input type="text"
               name="fcg_gofundme_master_component_id"
               value="<?php echo esc_attr($master_component_id); ?>"
               class="regular-text"
               placeholder="e.g., mKAgOmLtRHVGFGh_eaqM6">
        <p class="description">
            Component ID from Classy embed code. Used for frontend donation embeds.
            <br>Find this in Classy admin under campaign embed settings.
        </p>
    </td>
</tr>
```

**4. Update revalidate_template_campaign() static method:**

Rename to `revalidate_master_campaign()`.

Update all option names from `fcg_gfm_template_*` to `fcg_gofundme_master_*`.

**5. Update show_sync_notices() method:**

Change check from:
```php
if (get_option('fcg_gfm_template_validation_failed'))
```
To:
```php
if (get_option('fcg_gofundme_master_validation_failed'))
```

**6. Add migration for existing template setting:**

Add to constructor, after `if (!is_admin()) return;`:
```php
// Migrate template setting to master setting (one-time)
$this->maybe_migrate_template_setting();
```

Add new private method:
```php
/**
 * Migrate old template campaign setting to new master campaign setting
 * One-time migration for existing installations
 */
private function maybe_migrate_template_setting(): void {
    // Check if old setting exists and new setting doesn't
    $old_value = get_option('fcg_gfm_template_campaign_id');
    $new_value = get_option('fcg_gofundme_master_campaign_id');

    if ($old_value && !$new_value) {
        // Migrate campaign ID
        update_option('fcg_gofundme_master_campaign_id', $old_value);
        delete_option('fcg_gfm_template_campaign_id');

        // Migrate campaign name
        $old_name = get_option('fcg_gfm_template_campaign_name');
        if ($old_name) {
            update_option('fcg_gofundme_master_campaign_name', $old_name);
            delete_option('fcg_gfm_template_campaign_name');
        }

        // Clean up old validation options
        delete_option('fcg_gfm_template_validation_failed');
        delete_option('fcg_gfm_template_validation_pending');

        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('[FCG GoFundMe Sync] Migrated template campaign setting to master campaign setting');
        }
    }
}
```
  </action>
  <verify>
Run: `php -l includes/class-admin-ui.php`
Expect: No syntax errors

Run: `grep -n "fcg_gofundme_master_campaign_id" includes/class-admin-ui.php`
Expect: Multiple matches (new setting name used)

Run: `grep -n "fcg_gofundme_master_component_id" includes/class-admin-ui.php`
Expect: Multiple matches (new component setting added)

Run: `grep -n "fcg_gfm_template" includes/class-admin-ui.php`
Expect: Only in migration method (old references updated)
  </verify>
  <done>
- Settings renamed from "Template Campaign ID" to "Master Campaign ID"
- New "Master Component ID" setting added
- Option names standardized to fcg_gofundme_master_* pattern
- Migration method added for existing installations
- Validation methods updated for new naming
- File passes PHP lint check
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sync handler to link designation to master campaign after creation</name>
  <files>includes/class-sync-handler.php</files>
  <action>
Update FCG_GFM_Sync_Handler to link newly created designations to the master campaign.

**1. Update the create_designation() private method (around line 285):**

After the successful designation creation and meta storage, add the campaign linking call:

```php
private function create_designation(int $post_id, array $data): void {
    $result = $this->api->create_designation($data);

    if ($result['success'] && !empty($result['data']['id'])) {
        $designation_id = $result['data']['id'];

        // Store designation ID in post meta
        update_post_meta($post_id, self::META_KEY_DESIGNATION_ID, $designation_id);
        update_post_meta($post_id, self::META_KEY_LAST_SYNC, current_time('mysql'));

        // Also update ACF field if it exists
        if (function_exists('update_field')) {
            update_field(self::ACF_GROUP_KEY . '_gofundme_designation_id', $designation_id, $post_id);
        }

        $this->log_info("Created designation {$designation_id} for post {$post_id}");

        // Link designation to master campaign (adds to active designation group)
        $this->link_designation_to_campaign($designation_id, $post_id);

    } else {
        $error = $result['error'] ?? 'Unknown error';
        $this->log_error("Failed to create designation for post {$post_id}: {$error}");
    }
}
```

**2. Add new private method link_designation_to_campaign():**

Add after the create_designation() method:

```php
/**
 * Link a designation to the master campaign
 *
 * This adds the designation to the campaign's active designation group,
 * making it appear in the donation form dropdown.
 *
 * @param string|int $designation_id Designation ID
 * @param int $post_id WordPress post ID (for logging)
 */
private function link_designation_to_campaign($designation_id, int $post_id): void {
    $master_campaign_id = get_option('fcg_gofundme_master_campaign_id');

    if (empty($master_campaign_id)) {
        $this->log_info("Skipping campaign link for designation {$designation_id}: no master campaign configured");
        return;
    }

    $result = $this->api->update_campaign($master_campaign_id, [
        'designation_id' => $designation_id,
    ]);

    if ($result['success']) {
        $this->log_info("Linked designation {$designation_id} to master campaign {$master_campaign_id} for post {$post_id}");
    } else {
        $error = $result['error'] ?? 'Unknown error';
        $this->log_error("Failed to link designation {$designation_id} to master campaign {$master_campaign_id}: {$error}");
        // Note: We don't fail the overall sync - designation was created successfully
        // The linking can be retried or done manually in Classy UI
    }
}
```

**Important implementation notes:**
- The link_designation_to_campaign() call is AFTER the designation meta is saved, so if linking fails the designation is still tracked
- Linking failure is logged but doesn't fail the overall sync - the designation exists and can be linked later
- If no master campaign is configured, we skip silently with a log message
  </action>
  <verify>
Run: `php -l includes/class-sync-handler.php`
Expect: No syntax errors

Run: `grep -n "link_designation_to_campaign" includes/class-sync-handler.php`
Expect: At least 2 matches (method definition and call in create_designation)

Run: `grep -n "master_campaign_id" includes/class-sync-handler.php`
Expect: At least 2 matches (in link_designation_to_campaign method)

Run: `grep -n "update_campaign" includes/class-sync-handler.php`
Expect: 1 match (in link_designation_to_campaign method)
  </verify>
  <done>
- create_designation() now calls link_designation_to_campaign() after successful creation
- link_designation_to_campaign() method added with proper error handling
- Linking failure doesn't fail the overall sync
- Master campaign ID loaded from WordPress option
- All changes pass PHP lint check
  </done>
</task>

<task type="auto">
  <name>Task 3: Update main plugin file cron hook for renamed method</name>
  <files>fcg-gofundme-sync.php</files>
  <action>
Update the cron hook registration to use the renamed validation method.

In fcg-gofundme-sync.php, find line 41:
```php
add_action('fcg_gfm_revalidate_template', ['FCG_GFM_Admin_UI', 'revalidate_template_campaign']);
```

Change to:
```php
add_action('fcg_gfm_revalidate_master', ['FCG_GFM_Admin_UI', 'revalidate_master_campaign']);
```

Also update the hook name used in admin-ui.php validate_master_campaign_id() method where we schedule the cron:

In admin-ui.php, find in validate_master_campaign_id():
```php
if (!wp_next_scheduled('fcg_gfm_revalidate_template')) {
    wp_schedule_single_event(time() + 900, 'fcg_gfm_revalidate_template');
}
```

Change to:
```php
if (!wp_next_scheduled('fcg_gfm_revalidate_master')) {
    wp_schedule_single_event(time() + 900, 'fcg_gfm_revalidate_master');
}
```
  </action>
  <verify>
Run: `php -l fcg-gofundme-sync.php`
Expect: No syntax errors

Run: `grep -n "revalidate_master" fcg-gofundme-sync.php`
Expect: 1 match (hook registration)

Run: `grep -n "fcg_gfm_revalidate_master" includes/class-admin-ui.php`
Expect: At least 2 matches (scheduling and unscheduling)

Run: `grep -n "fcg_gfm_revalidate_template" fcg-gofundme-sync.php includes/class-admin-ui.php`
Expect: No matches (old hook name fully replaced)
  </verify>
  <done>
- Cron hook renamed from fcg_gfm_revalidate_template to fcg_gfm_revalidate_master
- Hook registration in main plugin file updated
- Hook scheduling in admin-ui.php updated
- Both files pass PHP lint check
  </done>
</task>

</tasks>

<verification>
1. All 3 files pass PHP syntax check
2. Settings page has "Master Campaign ID" and "Master Component ID" fields
3. Sync handler links new designations to master campaign
4. Cron hook properly renamed
5. Migration path exists for existing template setting
</verification>

<success_criteria>
- Admin settings page shows "Master Campaign ID" (renamed from Template)
- Admin settings page shows new "Master Component ID" field
- When a fund is published, designation is created AND linked to master campaign
- Old template setting automatically migrates to new master setting
- All PHP files pass lint check
</success_criteria>

<output>
After completion, create `.planning/phases/06-master-campaign-integration/06-01-SUMMARY.md`
</output>
