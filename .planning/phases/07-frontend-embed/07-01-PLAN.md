---
phase: 07-frontend-embed
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/chadmacbook/Local Sites/frederick-county-gives/app/public/wp-content/themes/community-foundation/fund-form.php
autonomous: true

must_haves:
  truths:
    - "Fund page displays Classy donation embed div"
    - "Embed uses master campaign ID from plugin settings"
    - "URL includes designation parameter for pre-selection"
    - "Graceful fallback shown when designation ID missing"
  artifacts:
    - path: "wp-content/themes/community-foundation/fund-form.php"
      provides: "Classy embed with designation pre-selection"
      contains: "classy="
  key_links:
    - from: "fund-form.php"
      to: "fcg_gofundme_master_campaign_id"
      via: "get_option()"
      pattern: "get_option.*fcg_gofundme_master_campaign_id"
    - from: "fund-form.php"
      to: "_gofundme_designation_id"
      via: "get_post_meta()"
      pattern: "get_post_meta.*_gofundme_designation_id"
---

<objective>
Replace legacy Acceptiva donation form with Classy embedded donation form in fund-form.php template.

Purpose: Enable donors to contribute directly through Classy with their chosen fund pre-selected in the designation dropdown.

Output: Updated fund-form.php template that renders Classy embed div and handles designation pre-selection via URL parameter.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-frontend-embed/07-RESEARCH.md
@.planning/phases/06-master-campaign-integration/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace fund-form.php with Classy embed</name>
  <files>/Users/chadmacbook/Local Sites/frederick-county-gives/app/public/wp-content/themes/community-foundation/fund-form.php</files>
  <action>
Replace the entire contents of fund-form.php with Classy embed implementation:

1. Get required values:
   - `$designation_id` from post meta `_gofundme_designation_id`
   - `$master_campaign_id` from option `fcg_gofundme_master_campaign_id`
   - `$master_component_id` from option `fcg_gofundme_master_component_id`

2. Render the embed div using verified format from Classy WP plugin:
   ```html
   <div id="{component_id}" classy="{campaign_id}"></div>
   ```

3. Handle designation pre-selection:
   - Classy SDK reads `?designation={id}` from URL parameters
   - Add JavaScript that uses `history.replaceState()` to inject designation parameter into URL if not present
   - This is non-disruptive (no page reload) and happens before SDK processes the div

4. Implement fallback for missing configuration:
   - If any of the three required values are missing, show graceful fallback message
   - Fallback should include contact link and clear message about donations coming soon

5. Use proper escaping:
   - `esc_attr()` for HTML attributes
   - `esc_js()` for JavaScript strings

Template structure (from 07-RESEARCH.md):
```php
<?php
// fund-form.php - Classy embed with designation pre-selection
$designation_id = get_post_meta(get_the_ID(), '_gofundme_designation_id', true);
$master_campaign_id = get_option('fcg_gofundme_master_campaign_id');
$master_component_id = get_option('fcg_gofundme_master_component_id');
?>

<h4>Make a Donation</h4>

<?php if ($designation_id && $master_campaign_id && $master_component_id): ?>
  <!-- Classy Embedded Donation Form -->
  <div id="<?php echo esc_attr($master_component_id); ?>"
       classy="<?php echo esc_attr($master_campaign_id); ?>"></div>

  <?php if (!isset($_GET['designation'])): ?>
  <!-- Add designation parameter for pre-selection -->
  <script>
    if (!window.location.search.includes('designation=')) {
      window.history.replaceState({}, '',
        window.location.href +
        (window.location.search ? '&' : '?') +
        'designation=<?php echo esc_js($designation_id); ?>'
      );
    }
  </script>
  <?php endif; ?>
<?php else: ?>
  <!-- Fallback when embed not configured -->
  <div class="donate-form-fallback">
    <p class="text-muted">
      Online donations for this fund are coming soon.
      Please <a href="/contact/">contact us</a> to make a donation.
    </p>
  </div>
<?php endif; ?>
```

IMPORTANT: Remove ALL legacy code including:
- The old `<form class="donate-form">` element
- Hidden input fields (js-product-name, js-product-amount)
- Add to cart button
- Cart title heading
- `get_template_part('fund-cart')` call

DO NOT keep any of the old form elements - they conflict with Classy SDK.
  </action>
  <verify>
Verify the file locally:
```bash
cat /Users/chadmacbook/Local\ Sites/frederick-county-gives/app/public/wp-content/themes/community-foundation/fund-form.php
```

Confirm:
- Contains `classy="` attribute in div
- Contains `get_option('fcg_gofundme_master_campaign_id')`
- Contains `get_option('fcg_gofundme_master_component_id')`
- Contains `get_post_meta(..., '_gofundme_designation_id', ...)`
- Contains `history.replaceState` for URL parameter injection
- Contains fallback div with "coming soon" message
- Does NOT contain `js-product-name`, `js-add-to-cart`, or `fund-cart`
  </verify>
  <done>
fund-form.php contains Classy embed div with:
- Master campaign ID from plugin settings
- Master component ID from plugin settings
- Designation ID from post meta
- URL parameter injection via JavaScript
- Graceful fallback for unconfigured funds
- All legacy Acceptiva form code removed
  </done>
</task>

</tasks>

<verification>
Local file verification:
```bash
# Check for Classy embed markers
grep -E "(classy=|fcg_gofundme_master|_gofundme_designation_id|history.replaceState)" "/Users/chadmacbook/Local Sites/frederick-county-gives/app/public/wp-content/themes/community-foundation/fund-form.php"

# Confirm legacy code removed
grep -c "js-add-to-cart\|fund-cart" "/Users/chadmacbook/Local Sites/frederick-county-gives/app/public/wp-content/themes/community-foundation/fund-form.php" || echo "Legacy code removed - OK"
```
</verification>

<success_criteria>
- fund-form.php renders Classy embed div with correct attributes
- Designation pre-selection via URL parameter is implemented
- Graceful fallback exists for funds without designation
- All legacy Acceptiva cart code removed
- File ready for deployment to staging
</success_criteria>

<output>
After completion, create `.planning/phases/07-frontend-embed/07-01-SUMMARY.md`
</output>
